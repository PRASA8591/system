<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMS ELITE | Cloud Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --dark: #0f172a;
            --surface: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f1f5f9;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Sidebar Transitions */
        aside {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 280px;
        }

        aside.collapsed {
            width: 80px;
        }

        aside.collapsed .nav-text,
        aside.collapsed .user-info {
            display: none;
        }

        aside.collapsed .nav-icon {
            margin: 0 auto;
            font-size: 1.5rem;
        }

        /* Glassmorphism & Cards */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fade {
            animation: fadeIn 0.3s ease-out;
        }

        /* Utils */
        .btn {
            transition: all 0.2s;
            active: scale(0.95);
        }
    </style>
</head>

<body>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="bg-slate-900 text-slate-300 flex flex-col h-full shrink-0 shadow-2xl z-50">
        <!-- Logo -->
        <div class="h-16 flex items-center px-6 border-b border-slate-800 gap-3 overflow-hidden whitespace-nowrap">
            <div
                class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white font-black italic shadow-lg shadow-blue-500/50 shrink-0">
                I</div>
            <div class="nav-text font-black text-xl text-white tracking-tight italic">IMS <span
                    class="text-blue-500">ELITE</span></div>
        </div>

        <!-- Navigation -->
        <nav id="nav-list" class="flex-1 overflow-y-auto py-4 space-y-1 px-3"></nav>

        <!-- User Profile -->
        <div class="h-20 border-t border-slate-800 p-4 flex items-center gap-3 hover:bg-slate-800 transition cursor-pointer"
            onclick="logout()">
            <div
                class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-lg shrink-0 border-2 border-slate-600">
                üë§</div>
            <div class="user-info overflow-hidden">
                <div id="disp-user" class="text-sm font-bold text-white truncate">Loading...</div>
                <div id="disp-loc" class="text-xs font-semibold text-blue-400 uppercase tracking-wider truncate">
                    Loading...</div>
            </div>
            <div class="nav-text ml-auto text-slate-500 hover:text-red-400">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-50 relative">
        <!-- Header -->
        <header
            class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 sticky top-0 z-40 shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-slate-100 text-slate-600 transition">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h7"></path>
                    </svg>
                </button>
                <h2 id="page-title" class="text-2xl font-black text-slate-800 tracking-tight uppercase">Dashboard</h2>
            </div>
            <div class="flex items-center gap-3">
                <div id="header-actions"></div>
                <div class="h-8 w-px bg-slate-200 mx-2"></div>
                <div class="text-xs font-bold text-slate-400" id="clock">00:00</div>
            </div>
        </header>

        <!-- Dynamic Page Content -->
        <div id="app" class="flex-1 overflow-auto p-6 relative">
            <!-- Content Injected Here -->
        </div>
    </main>

    <!-- GLOBAL COMPONENT: Modal -->
    <div id="modal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-[100] transition-opacity opacity-0">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl transform scale-95 transition-transform duration-200 flex flex-col max-h-[90vh]"
            id="modal-panel">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 id="m-title" class="text-lg font-black text-slate-800 uppercase tracking-tight">Title</h3>
                <button onclick="closeModal()"
                    class="text-slate-400 hover:text-red-500 rounded-full w-8 h-8 flex items-center justify-center transition hover:bg-red-50">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div id="m-body" class="p-6 overflow-y-auto custom-scrollbar"></div>
            <div id="m-footer" class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, where, getDoc, limit, orderBy, writeBatch, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDNpEbBt638KQGgkD4EvtqrRvInupP55zM",
            authDomain: "bills-de7ee.firebaseapp.com",
            projectId: "bills-de7ee",
            storageBucket: "bills-de7ee.firebasestorage.app",
            messagingSenderId: "970664008722",
            appId: "1:970664008722:web:d84829f233a6d40f6bcccb",
            measurementId: "G-WHSRHW81E0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- SESSION ---
        const session = JSON.parse(sessionStorage.getItem('ims_session'));
        if (!session) window.location.href = 'index.html';

        document.getElementById('disp-user').innerText = session.user;
        document.getElementById('disp-loc').innerText = session.loc;

        // --- UTILS ---
        window.formatCurrency = (n) => 'Rs ' + parseFloat(n || 0).toFixed(2);
        window.formatDate = (d) => new Date(d).toLocaleDateString();

        // --- NAVIGATION ---
        const PAGES = [
            { id: 'dashboard', n: 'Dashboard', icon: 'üìä' },
            { id: 'stock_check', n: 'Stock Check', icon: 'üîç' },
            { id: 'items', n: 'Item Master', icon: 'üì¶' },
            { id: 'suppliers', n: 'Suppliers', icon: 'üöõ' },
            { id: 'locations', n: 'Locations', icon: 'üè¢' },
            { id: 'users', n: 'Users', icon: 'üë•' },
            { id: 'direct_add', n: 'Direct Stock', icon: '‚ûï' },
            { id: 'po', n: 'Purchase Orders', icon: 'üìù' },
            { id: 'grn', n: 'GRN Receive', icon: 'üì•' },
            { id: 'prn', n: 'Purchase Returns', icon: 'üîô' },
            { id: 'transfer_out', n: 'Transfer Out', icon: 'üõ´' },
            { id: 'transfer_in', n: 'Transfer In', icon: 'üõ¨' },
            { id: 'verification', n: 'Audit / Adjust', icon: '‚öñÔ∏è' },
            { id: 'bincard', n: 'Bin Card', icon: 'üìã' },
            { id: 'billing', n: 'Billing POS', icon: 'üì†' },
            { id: 'reports', n: 'Reports', icon: 'üìà' }
        ];

        function initNav() {
            const nav = document.getElementById('nav-list');
            const allowed = session.perms || [];

            let html = '';
            PAGES.forEach(p => {
                // Admin sees all, or check specific permissions
                if (session.isAdmin || allowed.includes(p.id)) {
                    html += `
                        <div onclick="loadPage('${p.id}')" class="nav-item group flex items-center gap-3 px-3 py-3 rounded-xl cursor-pointer hover:bg-blue-600/10 hover:text-blue-400 transition-all mb-1 border-l-4 border-transparent hover:border-blue-500" id="nav-${p.id}">
                            <span class="text-xl group-hover:scale-110 transition nav-icon">${p.icon}</span>
                            <span class="font-bold text-sm tracking-wide nav-text">${p.n}</span>
                        </div>`;
                }
            });
            nav.innerHTML = html;
            loadPage('dashboard');
        }

        // --- CORE UI FUNCTIONS ---
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('collapsed');
        window.logout = () => { if (confirm('Logout?')) { sessionStorage.clear(); window.location.href = 'index.html'; } };

        window.openModal = (title, body, footerHtml = null) => {
            document.getElementById('m-title').innerText = title;
            document.getElementById('m-body').innerHTML = body;
            document.getElementById('m-footer').innerHTML = footerHtml || `<button onclick="closeModal()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300">Close</button>`;

            const m = document.getElementById('modal');
            m.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                m.classList.remove('opacity-0');
                document.getElementById('modal-panel').classList.remove('scale-95');
            }, 10);
        };

        window.closeModal = () => {
            const m = document.getElementById('modal');
            m.classList.add('opacity-0');
            document.getElementById('modal-panel').classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 200);
        };

        window.confirmAction = (msg, callbackName, ...args) => {
            const safeArgs = args.map(a => typeof a === 'string' ? `'${a}'` : a).join(',');
            window.openModal(
                "‚ö†Ô∏è Confirmation",
                `<div class="text-center py-8">
                    <div class="text-5xl mb-4">‚ùì</div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">${msg}</h3>
                    <p class="text-slate-500 text-sm">This action cannot be undone.</p>
                </div>`,
                `<button onclick="closeModal()" class="px-6 py-2 rounded-lg font-bold text-slate-600 hover:bg-slate-100">Cancel</button>
                 <button onclick="closeModal(); ${callbackName}(${safeArgs})" class="px-6 py-2 rounded-lg font-bold bg-black text-white hover:bg-slate-800 shadow-lg">Confirm</button>`
            );
        };

        // --- ID GENERATOR ---
        async function generateID(prefix, col) {
            // Simple counter based ID - in production use distributed counters or uuids
            // Here we just count docs to keep it simple as requested (ITEM000001)
            const snap = await getDocs(collection(db, col));
            const count = snap.size + 1;
            return prefix + count.toString().padStart(6, '0');
        }

        // --- HISTORY LOGGER ---
        async function logHistory(itemCode, type, qty, docNo = '-', fromLoc = '-', toLoc = '-') {
            await addDoc(collection(db, "history"), {
                date: new Date().toISOString(),
                itemCode, type, qty,
                user: session.user,
                loc: session.loc,
                docNo, fromLoc, toLoc
            });
        }

        // --- PRINTER UTILS ---
        window.printDoc = (title, metaHtml, tableHtml) => {
            const w = window.open('', '', 'width=900,height=800');
            w.document.write(`
                <html><head><title>${title}</title>
                <style>
                    body{font-family:'Segoe UI',sans-serif;padding:40px;color:#333}
                    .header{text-align:center;border-bottom:2px solid #000;padding-bottom:20px;margin-bottom:30px}
                    .meta{display:flex;justify-content:space-between;margin-bottom:30px;font-size:14px}
                    table{width:100%;border-collapse:collapse;font-size:13px}
                    th{background:#f0f0f0;padding:10px;text-align:left;border-bottom:1px solid #ddd}
                    td{padding:10px;border-bottom:1px solid #eee}
                    .footer{margin-top:50px;text-align:center;font-size:12px;color:#888;border-top:1px solid #eee;padding-top:20px}
                </style>
                </head><body>
                    <div class="header"><h1>${title}</h1><h3>IMS ELITE SYSTEM</h3></div>
                    <div class="meta">${metaHtml}</div>
                    <table>${tableHtml}</table>
                    <div class="footer">Generated on ${new Date().toLocaleString()} by ${session.user}</div>
                </body></html>
            `);
            w.print();
        };

        // --- PAGE LOADER ---
        window.loadPage = async (pageId) => {
            const p = PAGES.find(x => x.id === pageId);
            if (!p) return;

            // UI Update
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('bg-blue-600/10', 'text-blue-400', 'border-blue-500'));
            const activeNav = document.getElementById('nav-' + pageId);
            if (activeNav) activeNav.classList.add('bg-blue-600/10', 'text-blue-400', 'border-blue-500');

            document.getElementById('page-title').innerText = p.n;
            document.getElementById('app').innerHTML = `<div class="flex items-center justify-center h-64"><div class="animate-spin text-4xl">üí†</div></div>`;

            // Route
            if (pageId === 'dashboard') await loadDashboard();
            else if (pageId === 'items') await loadItems();
            else if (pageId === 'stock_check') await loadStockCheck();
            else if (pageId === 'suppliers') await loadSuppliers();
            else if (pageId === 'locations') await loadLocations();
            else if (pageId === 'users') await loadUsers();
            else if (pageId === 'direct_add') await loadDirectAdd();
            else if (pageId === 'po') await loadPO();
            else if (pageId === 'grn') await loadGRN();
            else if (pageId === 'prn') await loadPRN();
            else if (pageId === 'transfer_out') await loadTransferOut();
            else if (pageId === 'transfer_in') await loadTransferIn();
            else if (pageId === 'verification') await loadVerification();
            else if (pageId === 'bincard') await loadBincard();
            else if (pageId === 'billing') await loadBilling();
            else if (pageId === 'reports') await loadReports();
        };

        // ==========================================================================================
        // === MODULES PLACEHOLDERS ===
        // ==========================================================================================


        // === 1. DASHBOARD ===
        async function loadDashboard() {
            const loading = `<div class="animate-pulse flex space-x-4"><div class="h-12 w-full bg-slate-200 rounded"></div></div>`;
            document.getElementById('app').innerHTML = `<div class="grid grid-cols-1 md:grid-cols-4 gap-6" id="dash-grid">${loading}</div>`;

            // Fetch Data
            const stocksSnap = await getDocs(query(collection(db, "stocks"), where("loc", "==", session.loc)));
            const itemsSnap = await getDocs(collection(db, "items"));

            const stocks = stocksSnap.docs.map(d => d.data());
            const items = itemsSnap.docs.map(d => d.data());

            let val = 0, exp = 0, low = 0, short = 0;
            const now = new Date();
            const warningDate = new Date(); warningDate.setDate(now.getDate() + 30); // 30 Days Warning

            stocks.forEach(s => {
                const item = items.find(i => i.code === s.itemCode);
                if (item) val += (s.qty * (item.cost || 0));

                if (s.qty < 10) low++;

                if (s.exp && s.exp.includes('-')) {
                    const d = new Date(s.exp);
                    if (d < now) exp++;
                    else if (d < warningDate) short++;
                }
            });

            const cards = [
                { l: 'Stock Value', v: formatCurrency(val), c: 'blue', fn: 'val' },
                { l: 'Expired Items', v: exp, c: 'red', fn: 'exp' },
                { l: 'Short Expiry (30 Days)', v: short, c: 'orange', fn: 'short' },
                { l: 'Low Stock Alerts', v: low, c: 'yellow', fn: 'low' }
            ];

            const html = cards.map(c => `
                <div onclick="dashDetail('${c.fn}')" class="card p-6 border-l-4 border-${c.c}-500 cursor-pointer hover:bg-${c.c}-50 transition">
                    <div class="text-xs font-bold uppercase text-slate-400 mb-2">${c.l}</div>
                    <div class="text-3xl font-black text-${c.c}-600">${c.v}</div>
                </div>`).join('');

            document.getElementById('dash-grid').innerHTML = html;
        }

        window.dashDetail = async (type) => {
            const stocks = (await getDocs(query(collection(db, "stocks"), where("loc", "==", session.loc)))).docs.map(d => d.data());
            const items = (await getDocs(collection(db, "items"))).docs.map(d => d.data());
            const now = new Date();
            const warningDate = new Date(); warningDate.setDate(now.getDate() + 30);

            let filtered = [];
            let r = '';

            if (type === 'val') filtered = stocks;
            if (type === 'exp') filtered = stocks.filter(s => s.exp && new Date(s.exp) < now);
            if (type === 'short') filtered = stocks.filter(s => s.exp && new Date(s.exp) > now && new Date(s.exp) < warningDate);
            if (type === 'low') filtered = stocks.filter(s => s.qty < 10);

            r = filtered.map(s => {
                const i = items.find(x => x.code === s.itemCode);
                return `<tr><td>${s.itemCode}</td><td>${i?.name || '-'}</td><td>${s.qty}</td><td>${s.exp}</td></tr>`;
            }).join('');

            openModal("Details", `<div class="max-h-96 overflow-auto"><table class="w-full text-left text-sm"><thead><tr class="bg-slate-100"><th>Item</th><th>Name</th><th>Qty</th><th>Exp</th></tr></thead><tbody>${r}</tbody></table></div>`);
        };

        // === 2. ITEMS MASTER ===
        window.tempData = {};

        async function loadItems() {
            const snap = await getDocs(collection(db, "items"));
            document.getElementById('app').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <input id="search-item" placeholder="Search items..." class="p-3 rounded-lg border w-64 shadow-sm" onkeyup="filterTable('item-table', 1)">
                    <button onclick="itemModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition transform hover:scale-105">+ New</button>
                </div>
                <div class="card overflow-hidden">
                    <table class="w-full text-left border-collapse" id="item-table">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500">
                            <tr><th class="p-4">Code</th><th class="p-4">Name</th><th class="p-4">Pack</th><th class="p-4">Cost</th><th class="p-4">Sell</th><th class="p-4 text-right">Actions</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${snap.docs.map(d => {
                const i = d.data();
                return `<tr>
                                    <td class="p-4 font-mono font-bold text-blue-600">${i.code}</td>
                                    <td class="p-4 font-bold text-slate-700">${i.name}</td>
                                    <td class="p-4 text-slate-500">${i.pack || '-'}</td>
                                    <td class="p-4">${i.cost}</td>
                                    <td class="p-4">${i.sell}</td>
                                    <td class="p-4 text-right">
                                        <button onclick="itemModal('${d.id}')" class="text-blue-500 font-bold hover:underline mr-3">Edit</button>
                                        <button onclick="confirmAction('Delete ${i.code}?', 'delItem', '${d.id}')" class="text-red-500 font-bold hover:underline">Delete</button>
                                    </td>
                                </tr>`;
            }).join('')}
                        </tbody>
                    </table>
                </div>`;
        }

        window.itemModal = async (id = null) => {
            let d = { code: await generateID('ITEM', 'items'), name: '', pack: '', cost: 0, sell: 0 };
            if (id) d = (await getDoc(doc(db, "items", id))).data();
            window.tempData = { ...d, id };

            openModal(id ? 'Edit Item' : 'Create Item', `
                <div class="grid gap-4">
                    <div><label class="block text-xs font-bold uppercase text-slate-400 mb-1">Item Code</label>
                    <input value="${d.code}" disabled class="w-full p-2 bg-slate-100 rounded border border-slate-200 font-mono text-slate-500"></div>
                    
                    <div><label class="block text-xs font-bold uppercase text-slate-400 mb-1">Item Name</label>
                    <input id="i-n" value="${d.name}" class="w-full p-2 rounded border border-slate-300 focus:border-blue-500 outline-none"></div>

                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-xs font-bold uppercase text-slate-400 mb-1">Pack Size</label>
                        <input id="i-p" value="${d.pack}" class="w-full p-2 rounded border border-slate-300"></div>
                        <div><label class="block text-xs font-bold uppercase text-slate-400 mb-1">Cost Price</label>
                        <input id="i-c" value="${d.cost}" type="number" class="w-full p-2 rounded border border-slate-300"></div>
                        <div><label class="block text-xs font-bold uppercase text-slate-400 mb-1">Selling Price</label>
                        <input id="i-s" value="${d.sell}" type="number" class="w-full p-2 rounded border border-slate-300"></div>
                    </div>
                </div>
            `, `<button onclick="saveItemPrep()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Save Item</button>`);
        };

        window.saveItemPrep = () => {
            window.tempData.name = document.getElementById('i-n').value;
            window.tempData.pack = document.getElementById('i-p').value;
            window.tempData.cost = parseFloat(document.getElementById('i-c').value) || 0;
            window.tempData.sell = parseFloat(document.getElementById('i-s').value) || 0;
            if (!window.tempData.name) return alert("Name required");
            window.confirmAction('Confirm Save?', 'saveItemExec');
        };

        window.saveItemExec = async () => {
            if (window.tempData.id) await updateDoc(doc(db, "items", window.tempData.id), window.tempData);
            else await addDoc(collection(db, "items"), window.tempData);
            loadItems();
            window.closeModal();
        };
        window.delItem = async (id) => { await deleteDoc(doc(db, "items", id)); loadItems(); };


        // === 3. STOCK CHECK ===
        async function loadStockCheck() {
            document.getElementById('app').innerHTML = `
                <div class="card p-6 min-h-[500px]">
                    <h3 class="font-black text-2xl mb-4 text-slate-700">Stock Check</h3>
                    <input id="sc-search" placeholder="üîç Search Item Name or Code..." class="w-full p-4 text-lg border-2 border-slate-200 rounded-xl mb-6 focus:border-blue-500 outline-none" onkeyup="renderStockCheck()">
                    <div id="sc-res" class="overflow-auto"></div>
                </div>`;
            window.renderStockCheck();
        }

        window.renderStockCheck = async () => {
            const q = document.getElementById('sc-search').value.toLowerCase();
            const items = (await getDocs(collection(db, "items"))).docs.map(d => d.data());
            const stocks = (await getDocs(query(collection(db, "stocks"), where("loc", "==", session.loc)))).docs.map(d => d.data());

            // Grouping
            const grouped = {};
            stocks.forEach(s => {
                if (!grouped[s.itemCode]) grouped[s.itemCode] = { qty: 0, batches: [] };
                grouped[s.itemCode].qty += s.qty;
                grouped[s.itemCode].batches.push(s);
            });

            const rows = items.filter(i => i.name.toLowerCase().includes(q) || i.code.toLowerCase().includes(q)).map(i => {
                const s = grouped[i.code] || { qty: 0, batches: [] };
                return `<tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                    <td class="p-4 font-mono font-bold text-slate-500">${i.code}</td>
                    <td class="p-4 font-bold text-lg text-slate-800">${i.name}</td>
                    <td class="p-4 text-right font-black text-xl text-blue-600">${s.qty}</td>
                    <td class="p-4 text-right"><button onclick="viewBatches('${i.code}')" class="text-xs bg-slate-200 px-3 py-1 rounded-full font-bold hover:bg-slate-300">View Details</button></td>
                </tr>`;
            }).join('');

            document.getElementById('sc-res').innerHTML = `<table class="w-full"><thead><tr class="text-xs uppercase text-slate-400 font-bold"><th>Code</th><th>Item</th><th class="text-right">Total Qty</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
            window.currentBatches = grouped; // Store for modal
        };

        window.viewBatches = (code) => {
            const b = window.currentBatches[code]?.batches || [];
            if (b.length === 0) return alert("No Stock");
            const h = b.map(x => `<tr><td class="p-2 border-b">${x.exp || 'NuLL'}</td><td class="p-2 border-b font-bold">${x.qty}</td></tr>`).join('');
            openModal(`Stock: ${code}`, `<table class="w-full text-sm"><thead><tr><th>Expiry Date</th><th>Qty</th></tr></thead><tbody>${h}</tbody></table>`);
        };


        // === 4. SUPPLIERS ===
        async function loadSuppliers() {
            const snap = await getDocs(collection(db, "suppliers"));
            document.getElementById('app').innerHTML = `
                <div class="flex justify-between mb-4"><h3 class="font-bold text-xl">Supplier List</h3><button onclick="supModal()" class="btn bg-blue-600 text-white px-4 py-2 rounded font-bold">+ New Supplier</button></div>
                <div class="card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-100 uppercase text-xs font-bold text-slate-500"><tr><th class="p-3">Name</th><th class="p-3">Contact</th><th class="p-3">Actions</th></tr></thead>
                        <tbody>${snap.docs.map(d => `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-bold">${d.data().name}</td><td class="p-3">${d.data().contact}</td><td class="p-3"><button onclick="supModal('${d.id}')" class="text-blue-500 font-bold mr-2">Edit</button><button onclick="confirmAction('Delete?', 'delSup', '${d.id}')" class="text-red-500 font-bold">Del</button></td></tr>`).join('')}</tbody>
                    </table>
                </div>`;
        }
        window.supModal = async (id = null) => {
            let d = { name: '', contact: '' }; if (id) d = (await getDoc(doc(db, "suppliers", id))).data();
            window.tempData = { ...d, id };
            openModal("Supplier", `<div class="grid gap-3"><label class="font-bold text-xs uppercase text-slate-400">Name</label><input id="s-n" value="${d.name}" class="p-2 border rounded w-full"><label class="font-bold text-xs uppercase text-slate-400">Contact</label><input id="s-c" value="${d.contact}" class="p-2 border rounded w-full"></div>`, `<button onclick="saveSupPrep()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Save</button>`);
        };
        window.saveSupPrep = () => { window.tempData.name = document.getElementById('s-n').value; window.tempData.contact = document.getElementById('s-c').value; confirmAction("Save Supplier?", "saveSupExec"); };
        window.saveSupExec = async () => { if (window.tempData.id) await updateDoc(doc(db, "suppliers", window.tempData.id), window.tempData); else await addDoc(collection(db, "suppliers"), window.tempData); loadSuppliers(); closeModal(); };
        window.delSup = async (id) => { await deleteDoc(doc(db, "suppliers", id)); loadSuppliers(); };


        // === 5. LOCATIONS ===
        async function loadLocations() {
            const snap = await getDocs(collection(db, "locations"));
            document.getElementById('app').innerHTML = `
                <div class="flex justify-between mb-4"><h3 class="font-bold text-xl">Locations</h3><button onclick="locWiz1()" class="btn bg-blue-600 text-white px-4 py-2 rounded font-bold">+ New Location</button></div>
                <div class="card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-100 uppercase text-xs font-bold text-slate-500"><tr><th class="p-3">Name</th><th class="p-3">Remark</th><th class="p-3">Active Pages</th><th class="p-3">Actions</th></tr></thead>
                        <tbody>${snap.docs.map(d => `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-bold">${d.data().name}</td><td class="p-3 text-sm text-slate-500">${d.data().remark}</td><td class="p-3"><span class="bg-slate-100 px-2 rounded text-xs font-bold">${d.data().pages?.length || 0} Pages</span></td><td class="p-3"><button onclick="locWiz1('${d.id}')" class="text-blue-500 font-bold mr-2">Edit</button><button onclick="confirmAction('Delete?', 'delLoc', '${d.id}')" class="text-red-500 font-bold">Del</button></td></tr>`).join('')}</tbody>
                    </table>
                </div>`;
        }
        window.locWiz1 = async (id = null) => {
            let d = { name: '', remark: '', pages: [] }; if (id) d = (await getDoc(doc(db, "locations", id))).data();
            window.tempData = { ...d, id };
            openModal("Step 1: Location Info",
                `<div class="grid gap-3">
                    <label class="font-bold text-xs uppercase text-slate-400">Location Name</label><input id="l-n" value="${d.name}" class="p-2 border rounded w-full">
                    <label class="font-bold text-xs uppercase text-slate-400">Remark</label><input id="l-r" value="${d.remark}" class="p-2 border rounded w-full">
                </div>`,
                `<button onclick="locWiz2()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Next ></button>`);
        };
        window.locWiz2 = () => {
            window.tempData.name = document.getElementById('l-n').value;
            window.tempData.remark = document.getElementById('l-r').value;
            if (!window.tempData.name) return alert("Name Required");

            const checks = PAGES.map(p => `
                <label class="flex items-center gap-3 p-3 border rounded hover:bg-slate-50 cursor-pointer">
                    <input type="checkbox" value="${p.id}" class="pg-chk w-5 h-5 accent-blue-600" ${window.tempData.pages.includes(p.id) ? 'checked' : ''}>
                    <span class="font-bold text-slate-700">${p.n}</span>
                </label>`).join('');

            openModal("Step 2: Page Access", `<div class="grid grid-cols-2 gap-2 max-h-[400px] overflow-auto">${checks}</div>`, `<button onclick="saveLocPrep()" class="bg-green-600 text-white px-4 py-2 rounded font-bold">Create Location</button>`);
        };
        window.saveLocPrep = () => {
            window.tempData.pages = Array.from(document.querySelectorAll('.pg-chk:checked')).map(x => x.value);
            confirmAction("Confirm Location?", "saveLocExec");
        };
        window.saveLocExec = async () => {
            if (window.tempData.id) await updateDoc(doc(db, "locations", window.tempData.id), window.tempData); else await addDoc(collection(db, "locations"), window.tempData);
            loadLocations(); closeModal();
        };
        window.delLoc = async (id) => { await deleteDoc(doc(db, "locations", id)); loadLocations(); };


        // === 6. USERS ===
        async function loadUsers() {
            const snap = await getDocs(collection(db, "users"));
            document.getElementById('app').innerHTML = `
                <div class="flex justify-between mb-4"><h3 class="font-bold text-xl">User Access</h3><button onclick="usrWiz1()" class="btn bg-blue-600 text-white px-4 py-2 rounded font-bold">+ New User</button></div>
                <div class="card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-100 uppercase text-xs font-bold text-slate-500"><tr><th class="p-3">Username</th><th class="p-3">Full Name</th><th class="p-3">Locations</th><th class="p-3">Actions</th></tr></thead>
                        <tbody>${snap.docs.map(d => `<tr class="border-b hover:bg-slate-50"><td class="p-3 font-bold text-blue-600">${d.data().username}</td><td class="p-3 font-bold">${d.data().fullName}</td><td class="p-3 text-xs w-48">${d.data().allowedLocs?.join(', ')}</td><td class="p-3"><button onclick="usrWiz1('${d.id}')" class="text-blue-500 font-bold mr-2">Edit</button><button onclick="confirmAction('Delete?', 'delUsr', '${d.id}')" class="text-red-500 font-bold">Del</button></td></tr>`).join('')}</tbody>
                    </table>
                </div>`;
        }
        window.usrWiz1 = async (id = null) => {
            let d = { username: '', fullName: '', password: '', allowedLocs: [], permissions: [] };
            if (id) d = (await getDoc(doc(db, "users", id))).data();
            window.tempData = { ...d, id };

            openModal("Step 1: User Credentials", `
                <div class="grid gap-3">
                    <label class="font-bold text-xs uppercase text-slate-400">Full Name</label><input id="u-f" value="${d.fullName}" class="p-2 border rounded w-full">
                    <label class="font-bold text-xs uppercase text-slate-400">Username</label><input id="u-u" value="${d.username}" class="p-2 border rounded w-full">
                    <label class="font-bold text-xs uppercase text-slate-400">Password</label><input id="u-p" value="${d.password}" type="text" class="p-2 border rounded w-full">
                </div>
            `, `<button onclick="usrWiz2()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Next ></button>`);
        };
        window.usrWiz2 = async () => {
            window.tempData.fullName = document.getElementById('u-f').value;
            window.tempData.username = document.getElementById('u-u').value;
            window.tempData.password = document.getElementById('u-p').value;

            const locs = await getDocs(collection(db, "locations"));
            const checks = locs.docs.map(l => `
                <label class="flex items-center gap-3 p-3 border rounded hover:bg-slate-50 cursor-pointer">
                    <input type="checkbox" value="${l.data().name}" class="loc-chk w-5 h-5 accent-blue-600" ${window.tempData.allowedLocs.includes(l.data().name) ? 'checked' : ''}>
                    <span class="font-bold text-slate-700">${l.data().name}</span>
                </label>`).join('');

            openModal("Step 2: Allowed Locations", `<div class="grid gap-2">${checks}</div>`, `<button onclick="usrWiz3()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Next ></button>`);
        };
        window.usrWiz3 = () => {
            window.tempData.allowedLocs = Array.from(document.querySelectorAll('.loc-chk:checked')).map(x => x.value);

            const checks = PAGES.map(p => `
                <label class="flex items-center gap-3 p-3 border rounded hover:bg-slate-50 cursor-pointer">
                    <input type="checkbox" value="${p.id}" class="perm-chk w-5 h-5 accent-blue-600" ${window.tempData.permissions?.includes(p.id) ? 'checked' : ''}>
                    <span class="font-bold text-slate-700">${p.n}</span>
                </label>`).join('');

            openModal("Step 3: User Permissions", `<div class="grid grid-cols-2 gap-2 max-h-[400px] overflow-auto">${checks}</div>`, `<button onclick="saveUsrPrep()" class="bg-green-600 text-white px-4 py-2 rounded font-bold">Create User</button>`);
        };
        window.saveUsrPrep = () => {
            window.tempData.permissions = Array.from(document.querySelectorAll('.perm-chk:checked')).map(x => x.value);
            confirmAction("Confirm User?", "saveUsrExec");
        };
        window.saveUsrExec = async () => {
            if (window.tempData.id) await updateDoc(doc(db, "users", window.tempData.id), window.tempData); else await addDoc(collection(db, "users"), window.tempData);
            loadUsers(); closeModal();
        };
        window.delUsr = async (id) => { await deleteDoc(doc(db, "users", id)); loadUsers(); };


        // === 7. DIRECT STOCK ADD ===
        async function loadDirectAdd() {
            const snap = await getDocs(collection(db, "items"));
            document.getElementById('app').innerHTML = `
                <div class="max-w-md mx-auto card p-8 mt-10">
                    <h3 class="font-black text-2xl mb-6 text-slate-700">Direct Stock Entry</h3>
                    <div class="grid gap-4">
                        <div><label class="font-bold text-xs uppercase text-slate-400">Item Name</label>
                        <select id="da-i" class="w-full p-3 border rounded-lg bg-slate-50">${snap.docs.map(d => `<option value="${d.data().code}">${d.data().name}</option>`).join('')}</select></div>
                        <div><label class="font-bold text-xs uppercase text-slate-400">Quantity</label>
                        <input id="da-q" type="number" class="w-full p-3 border rounded-lg" placeholder="Enter Qty"></div>
                        <div><label class="font-bold text-xs uppercase text-slate-400">Expiry Date</label>
                        <input id="da-e" type="date" class="w-full p-3 border rounded-lg"></div>
                        <button onclick="saveDAPrep()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 mt-2">Add Stock</button>
                    </div>
                </div>`;
        }
        window.saveDAPrep = () => {
            const q = document.getElementById('da-q').value;
            const e = document.getElementById('da-e').value;
            if (!q || !e) return alert("Fill all fields");
            confirmAction("Add Stock?", "saveDAExec");
        };
        window.saveDAExec = async () => {
            const i = document.getElementById('da-i').value;
            const q = parseFloat(document.getElementById('da-q').value);
            const e = document.getElementById('da-e').value;
            await addDoc(collection(db, "stocks"), { itemCode: i, loc: session.loc, qty: q, exp: e, date: new Date().toISOString() });
            await logHistory(i, 'DIRECT', q);
            alert("Stock Added!");
            loadDirectAdd();
            window.closeModal();
        };


        // === 8. PURCHASE ORDERS (PO) ===
        async function loadPO() {
            // Admin sees all, others see local if we had local POs (but PO is usually global or by supplier)
            // For now, let's assume PO is global but we want to filter by date desc
            const raw = await getDocs(collection(db, "docs"));
            // Client-side sort/filter to avoid index issues during dev
            const snap = { docs: raw.docs.filter(d => d.data().type === 'PO').sort((a, b) => new Date(b.data().date) - new Date(a.data().date)) };

            document.getElementById('app').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-black text-2xl text-slate-800">Purchase Orders</h3>
                        <p class="text-slate-500 text-sm">Manage supplier orders and procurement</p>
                    </div>
                    <div class="flex gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                        <input id="po-find" placeholder="Search PO Number..." class="border-none bg-transparent p-2 text-sm w-48 focus:ring-0 font-medium">
                        <button onclick="viewOldPOByNo()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 rounded-lg font-bold text-xs uppercase tracking-wide transition">Find</button>
                    </div>
                    <button onclick="createPO()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-blue-200 transition transform active:scale-95 flex items-center gap-2">
                        <span>+ New Order</span>
                    </button>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100 uppercase text-xs font-black text-slate-400 tracking-wider">
                            <tr><th class="p-4">PO Number</th><th class="p-4">Supplier</th><th class="p-4">Status</th><th class="p-4">Date</th><th class="p-4">Actions</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${snap.docs.map(d => `
                            <tr class="hover:bg-slate-50 transition-colors group">
                                <td class="p-4 font-mono font-bold text-blue-600 group-hover:text-blue-700">${d.data().docNo}</td>
                                <td class="p-4 font-bold text-slate-700">${d.data().supplier}</td>
                                <td class="p-4">
                                    <span class="px-2.5 py-1 rounded-md text-[10px] font-black tracking-wide uppercase ${d.data().status === 'PENDING' ? 'bg-amber-100 text-amber-700' : d.data().status === 'RECEIVED' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}">
                                        ${d.data().status}
                                    </span>
                                </td>
                                <td class="p-4 text-sm text-slate-500 font-medium">${formatDate(d.data().date)}</td>
                                <td class="p-4 flex gap-2 items-center">
                                    <button onclick="openPOModal('${d.id}')" class="text-slate-400 hover:text-blue-600 font-bold text-xs bg-transparent p-2 rounded hover:bg-blue-50 transition">View</button>
                                    ${d.data().status === 'PENDING' ? `
                                        <button onclick="goToGRNFromPO('${d.data().docNo}')" class="text-emerald-500 hover:text-emerald-700 font-bold text-xs px-2 py-1 bg-emerald-50 rounded hover:bg-emerald-100 transition">Receive</button>
                                        <button onclick="cancelPO('${d.id}')" class="text-rose-400 hover:text-rose-600 hover:bg-rose-50 p-1.5 rounded transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                    ` : ''}
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                    ${snap.docs.length === 0 ? '<div class="p-12 text-center text-slate-400 italic">No Purchase Orders found.</div>' : ''}
                </div>`;
        }
        window.viewOldPOByNo = async () => {
            const n = document.getElementById('po-find').value.trim();
            if (!n) return alert("Enter PO Number");
            const snap = await getDocs(query(collection(db, "docs"), where("docNo", "==", n), where("type", "==", "PO")));
            if (snap.empty) return alert("PO Not Found");
            openPOModal(snap.docs[0].id);
        };
        // kept viewOldPO for compatibility if used elsewhere, but main UI uses viewOldPOByNo now
        window.viewOldPO = () => window.viewOldPOByNo();

        window.openPOModal = async (id) => {
            const d = (await getDoc(doc(db, "docs", id))).data();
            const items = await getDocs(collection(db, "items"));
            const allItems = items.docs.map(i => i.data());

            const rows = d.items.map(x => {
                const i = allItems.find(z => z.code === x.code);
                return `<tr>
                    <td class="p-3">
                        <div class="font-bold text-slate-700">${i?.name || 'Unknown'}</div>
                        <div class="text-xs text-slate-400 font-mono">${x.code}</div>
                    </td>
                    <td class="p-3 text-right font-black text-lg text-blue-600">${x.qty}</td>
                    <td class="p-3 text-right text-slate-500">${i?.pack || '-'}</td>
                </tr>`;
            }).join('');

            openModal(`Purchase Order Details`,
                `<div class="bg-indigo-50 border border-indigo-100 rounded-xl p-4 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-xs uppercase font-bold text-indigo-400 mb-1">PO Number</div>
                            <div class="text-2xl font-black text-indigo-900 font-mono">${d.docNo}</div>
                        </div>
                        <div class="text-right">
                             <div class="text-xs uppercase font-bold text-indigo-400 mb-1">Status</div>
                             <span class="px-3 py-1 rounded bg-white text-indigo-600 text-xs font-black uppercase tracking-wide shadow-sm border border-indigo-100">${d.status}</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-indigo-200 grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs uppercase font-bold text-indigo-400">Supplier</div>
                            <div class="font-bold text-slate-700">${d.supplier}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs uppercase font-bold text-indigo-400">Date Logged</div>
                            <div class="font-bold text-slate-700">${formatDate(d.date)}</div>
                        </div>
                    </div>
                 </div>
                 
                 <div class="uppercase text-xs font-bold text-slate-400 mb-2 tracking-wide pl-1">Items Ordered</div>
                 <div class="border rounded-xl overflow-hidden shadow-sm">
                    <table class="w-full text-sm text-left bg-white">
                        <thead class="bg-slate-50 border-b border-slate-100 text-slate-500 uppercase text-[10px]">
                            <tr><th class="p-3">Item Details</th><th class="p-3 text-right">Order Qty</th><th class="p-3 text-right">Pack Size</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">${rows}</tbody>
                    </table>
                 </div>`,
                `<button onclick="closeModal()" class="w-full bg-slate-800 text-white px-6 py-3 rounded-xl font-bold hover:scale-[1.02] transition shadow-lg">Close View</button>`);
        };

        // Helper for Success
        window.showCreatedDoc = (id, type) => {
            openModal("Success!", `
                <div class="text-center">
                    <div class="text-4xl mb-4">‚úÖ</div>
                    <div class="font-bold text-slate-500 mb-2">${type} Created Successfully</div>
                    <div class="text-3xl font-black text-blue-600 mb-4 tracking-wider p-4 bg-blue-50 rounded-xl border border-blue-200 dashed">${id}</div>
                    <p class="text-xs text-slate-400 mb-6">Use this number for future references (e.g., GRN).</p>
                    <div class="grid gap-2">
                        <button onclick="navigator.clipboard.writeText('${id}');alert('Copied!')" class="w-full bg-slate-200 text-slate-700 p-3 rounded-lg font-bold">Copy Number</button>
                    </div>
                </div>
             `, `<button onclick="closeModal()" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Done</button>`);
        };
        window.createPO = async () => {
            const s = await getDocs(collection(db, "suppliers"));
            const i = await getDocs(collection(db, "items"));
            window.tempItems = [];

            const supOpt = s.docs.map(x => `<option value="${x.data().name}">${x.data().name}</option>`).join('');
            // Store attributes for cleaner display
            const itemOpt = i.docs.map(x => `<option value="${x.data().code}" data-name="${x.data().name}" data-pack="${x.data().packSize || '1'}">${x.data().name}</option>`).join('');

            openModal("New Purchase Order", `
                <div class="grid gap-4">
                    <div>
                        <label class="font-bold text-xs uppercase text-slate-400">Select Supplier</label>
                        <select id="po-s" class="w-full p-3 border rounded-xl font-bold bg-slate-50 text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 transition">${supOpt}</select>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                         <div class="mb-2 font-bold text-sm text-slate-500 uppercase tracking-wide">Add Items to Order</div>
                         <div class="flex gap-2 mb-3">
                             <div class="flex-1">
                                <select id="po-i" class="w-full p-2 text-sm border rounded-lg outline-none focus:border-blue-500">${itemOpt}</select>
                             </div>
                             <div class="w-24">
                                <input id="po-q" type="number" placeholder="Qty" class="w-full p-2 text-sm border rounded-lg text-center font-bold outline-none focus:border-blue-500">
                             </div>
                             <button onclick="addPOItem()" class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-lg font-bold shadow-md transition transform active:scale-95">+</button>
                         </div>
                    </div>

                    <div id="po-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-1">
                        <!-- Items will appear here -->
                        <div class="text-center text-slate-400 text-sm py-4 italic">No items added yet</div>
                    </div>
                </div>
             `, `<button onclick="savePOPrep()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition transform active:scale-[0.98]">Create Purchase Order</button>`);
        };

        window.addPOItem = () => {
            const iSel = document.getElementById('po-i');
            const code = iSel.value;
            const name = iSel.options[iSel.selectedIndex].dataset.name;
            const pack = iSel.options[iSel.selectedIndex].dataset.pack;
            const qty = parseFloat(document.getElementById('po-q').value);

            if (!qty || qty <= 0) return alert("Please enter a valid Quantity");

            const existing = window.tempItems.find(x => x.code === code);
            if (existing) {
                existing.qty += qty;
            } else {
                window.tempItems.push({ code, name, pack, qty });
            }

            document.getElementById('po-list').innerHTML = window.tempItems.map((x, idx) => `
                <div class="flex justify-between items-center bg-white p-3 border border-slate-100 rounded-xl shadow-sm hover:shadow-md transition group">
                    <div>
                        <div class="font-bold text-slate-700">${x.name}</div>
                        <div class="text-xs text-slate-400 font-mono flex gap-2">
                            <span>Code: ${x.code}</span>
                            <span class="text-slate-300">|</span>
                            <span>Pack: ${x.pack}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-xl text-blue-600 bg-blue-50 px-3 py-1 rounded-lg">${x.qty}</span>
                        <button onclick="window.tempItems.splice(${idx},1);addPOItem()" class="text-slate-300 hover:text-red-500 hover:bg-red-50 p-1 rounded transition">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>`).join('');

            // Reset Input
            document.getElementById('po-q').value = '';
            document.getElementById('po-i').focus();
        };
        window.savePOPrep = async () => {
            if (window.tempItems.length === 0) return alert("No items");
            const sup = document.getElementById('po-s').value;
            if (!sup) return alert("Select Supplier");
            confirmAction("Generate PO?", "savePOExec", sup);
        };
        window.savePOExec = async (sup) => {
            // sup passed as arg
            const id = await generateID('PO', 'docs');
            try {
                await setDoc(doc(db, "docs", id), {
                    docNo: id, type: 'PO', supplier: sup, items: window.tempItems, status: 'PENDING', date: new Date().toISOString()
                });
                loadPO();
                // Enhanced Success Popup like Transfer Out
                openModal("Success!", `
                    <div class="text-center py-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 text-green-500 mb-6 animate-fade">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                        <h3 class="text-xl font-black text-slate-800 mb-2">Purchase Order Created</h3>
                        <p class="text-slate-500 mb-6">Order has been successfully logged.</p>
                        
                        <div class="bg-slate-50 rounded-xl border border-slate-200 p-4 mb-6">
                            <div class="text-xs uppercase font-bold text-slate-400 mb-1">PO Number</div>
                            <div class="text-3xl font-black text-blue-600 tracking-tight font-mono select-all">${id}</div>
                        </div>

                        <p class="text-xs text-slate-400">You can receive stock against this PO in the GRN section.</p>
                    </div>
                `, `<button onclick="closeModal()" class="w-full bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:scale-[1.02] transition shadow-xl">Done</button>`);
            } catch (e) {
                console.error("PO Save Error:", e);
                alert("Error saving PO: " + e.message);
            }
        };
        window.cancelPO = async (id) => {
            confirmAction("Cancel PO?", "cancelPOExec", id);
        };
        window.cancelPOExec = async (id) => {
            await updateDoc(doc(db, "docs", id), { status: 'CANCELLED' });
            closeModal(); loadPO();
        };
        window.goToGRNFromPO = (poNo) => {
            loadPage('grn');
            setTimeout(() => { document.getElementById('grn-po').value = poNo; loadGRNFromPO(); }, 500);
        };


        // === 9. GRN ===
        async function loadGRN() {
            const raw = await getDocs(query(collection(db, "docs"), where("type", "==", "GRN")));
            const snap = { docs: raw.docs.sort((a, b) => new Date(b.data().date) - new Date(a.data().date)) };

            document.getElementById('app').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-black text-2xl text-slate-800">Goods Received (GRN)</h3>
                        <p class="text-slate-500 text-sm">History of stock received from suppliers</p>
                    </div>
                    <div class="flex gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                        <input id="old-grn" placeholder="PO# or GRN#..." class="border-none bg-transparent p-2 text-sm w-48 focus:ring-0 font-medium">
                        <button onclick="viewOldGRNByNo()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 rounded-lg font-bold text-xs uppercase tracking-wide transition">Find</button>
                    </div>
                    <button onclick="createGRN()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-green-200 transition transform active:scale-95 flex items-center gap-2">
                        <span>+ Receive Stock</span>
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100 uppercase text-xs font-black text-slate-400 tracking-wider">
                            <tr><th class="p-4">GRN #</th><th class="p-4">PO Ref</th><th class="p-4">Invoice</th><th class="p-4">Date</th><th class="p-4">Actions</th></tr>
                        </thead>
                       <tbody class="divide-y divide-slate-50">
                            ${snap.docs.map(d => `
                            <tr class="hover:bg-slate-50 transition-colors group">
                                <td class="p-4 font-mono font-bold text-green-600 group-hover:text-green-700">${d.data().docNo}</td>
                                <td class="p-4 font-bold text-slate-700">${d.data().ref}</td>
                                <td class="p-4 text-sm font-medium text-slate-600">${d.data().invoice}</td>
                                <td class="p-4 text-sm text-slate-500 font-medium">${formatDate(d.data().date)}</td>
                                <td class="p-4">
                                    <button onclick="viewOldGRNByNo('${d.data().docNo}')" class="text-slate-400 hover:text-blue-600 font-bold text-xs bg-transparent p-2 rounded hover:bg-blue-50 transition flex items-center gap-1">
                                        View Details
                                    </button>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                    ${snap.docs.length === 0 ? '<div class="p-12 text-center text-slate-400 italic">No GRN History found.</div>' : ''}
                </div>`;
        }

        window.createGRN = () => {
            openModal("New GRN - Step 1", `
                <div class="mb-4">
                    <label class="font-bold text-xs uppercase text-slate-400">Enter Purchase Order (PO) Number</label>
                    <div class="flex gap-2 mt-1">
                        <input id="grn-po" placeholder="PO00000X" class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold">
                        <button onclick="loadGRNFromPO()" class="bg-blue-600 text-white px-4 rounded-lg font-bold">Load PO</button>
                    </div>
                </div>
                <div id="grn-area" class="hidden animate-fade border-t pt-4">
                        <div class="bg-blue-50 border border-blue-100 p-4 rounded-lg mb-6 flex justify-between">
                            <div><div class="text-xs font-bold text-slate-400 uppercase">PO Reference</div><div id="g-po" class="font-bold text-lg"></div></div>
                            <div><div class="text-xs font-bold text-slate-400 uppercase">Supplier</div><div id="g-sup" class="font-bold text-lg"></div></div>
                        </div>
                        <div class="mb-4"><label class="font-bold text-xs uppercase text-slate-400">Invoice Number</label><input id="g-inv" class="w-full p-2 border rounded"></div>
                        <div id="g-items" class="space-y-3 max-h-[300px] overflow-auto custom-scrollbar"></div>
                        <button onclick="saveGRNPrep()" class="w-full bg-green-600 text-white p-4 rounded-xl font-black text-lg shadow-xl shadow-green-200 mt-6 hover:scale-[1.02] transition">CREATE GRN</button>
                </div>
             `);
        };
        window.loadGRNFromPO = async () => {
            const n = document.getElementById('grn-po').value.trim();
            if (!n) return alert("Enter PO Number");
            const snap = await getDocs(query(collection(db, "docs"), where("docNo", "==", n), where("type", "==", "PO")));
            if (snap.empty) return alert("PO Not Found");
            const po = snap.docs[0].data();
            if (po.status !== 'PENDING') return alert("PO is " + po.status);

            window.tempPOId = snap.docs[0].id; // Store Doc ID for status update
            document.getElementById('grn-area').classList.remove('hidden');
            document.getElementById('g-po').innerText = po.docNo;
            document.getElementById('g-sup').innerText = po.supplier;

            // Fetch items to get current cost/sell
            const allItems = (await getDocs(collection(db, "items"))).docs.map(d => d.data());

            document.getElementById('g-items').innerHTML = po.items.map((x, i) => {
                const itm = allItems.find(z => z.code === x.code) || {};
                return `
                 <div class="bg-white border p-4 rounded-lg shadow-sm" id="grow-${i}" data-code="${x.code}">
                    <div class="flex justify-between mb-2">
                        <span class="font-black text-slate-700">${x.code}</span>
                        <span class="text-xs bg-slate-100 px-2 py-1 rounded font-bold">Order: ${x.qty}</span>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <div><label class="text-[10px] font-bold uppercase text-slate-400">Rcv Qty</label><input type="number" class="w-full border rounded p-1 g-qty" value="${x.qty}"></div>
                        <div><label class="text-[10px] font-bold uppercase text-slate-400">Free</label><input type="number" class="w-full border rounded p-1 g-free" value="0"></div>
                        <div class="col-span-2"><label class="text-[10px] font-bold uppercase text-slate-400">Expiry</label><input type="date" class="w-full border rounded p-1 g-exp"></div>
                        <div><label class="text-[10px] font-bold uppercase text-slate-400">Total Cost</label><input type="number" class="w-full border rounded p-1 g-cost" value="${itm.cost || 0}"></div>
                        <div><label class="text-[10px] font-bold uppercase text-slate-400">New Sell</label><input type="number" class="w-full border rounded p-1 g-sell" value="${itm.sell || 0}"></div>
                    </div>
                 </div>`;
            }).join('');
        };
        window.saveGRNPrep = () => {
            const inv = document.getElementById('g-inv').value;
            if (!inv) return alert("Invoice Number Required");

            const rows = document.querySelectorAll('#g-items > div');
            const validItems = [];

            for (let r of rows) {
                const code = r.dataset.code;
                const q = parseFloat(r.querySelector('.g-qty').value) || 0;
                const f = parseFloat(r.querySelector('.g-free').value) || 0;
                const exp = r.querySelector('.g-exp').value;
                const cost = parseFloat(r.querySelector('.g-cost').value);
                const sell = parseFloat(r.querySelector('.g-sell').value);

                if (!exp) return alert("Expiry missing for " + code);
                if (q > 0) validItems.push({ code, q, f, exp, cost, sell });
            }

            if (validItems.length === 0) return alert("No items with Qty > 0");

            const ref = document.getElementById('g-po').innerText;
            // Store in temp global because DOM will be destroyed by confirm modal
            window.tempGRNData = { invItems: validItems, invoice: inv, poRef: ref };

            confirmAction("Finalize GRN?", "saveGRNExec");
        };
        window.saveGRNExec = async () => {
            const { invItems, invoice, poRef } = window.tempGRNData;
            const validItems = invItems;

            const id = await generateID('GRN', 'docs');
            const ref = poRef;
            const inv = invoice;


            // Process Stocks
            const batch = writeBatch(db);
            for (let x of validItems) {
                // Update Main Item Price
                const qI = query(collection(db, "items"), where("code", "==", x.code));
                const sI = await getDocs(qI);
                if (!sI.empty) batch.update(sI.docs[0].ref, { cost: x.cost, sell: x.sell });

                // Add Stock
                const stockRef = doc(collection(db, "stocks"));
                batch.set(stockRef, { itemCode: x.code, loc: session.loc, qty: (x.q + x.f), exp: x.exp, date: new Date().toISOString() });

                // Log
                await logHistory(x.code, 'GRN', (x.q + x.f), id);
            }

            // Save GRN Doc
            const grnRef = doc(collection(db, "docs"));
            batch.set(grnRef, { docNo: id, type: 'GRN', ref, invoice: inv, items: validItems, date: new Date().toISOString() });

            // Close PO
            if (window.tempPOId) batch.update(doc(db, "docs", window.tempPOId), { status: 'RECEIVED' });

            await batch.commit();
            loadGRN();
            showCreatedDoc(id, 'GRN');

            // Print Background
            setTimeout(() => {
                window.printDoc(`GRN: ${id}`, `PO Ref: ${ref}<br>Invoice: ${inv}`,
                    `<thead><tr><th>Item</th><th>Qty</th><th>Free</th><th>Exp</th><th>Cost</th></tr></thead><tbody>${validItems.map(z => `<tr><td>${z.code}</td><td>${z.q}</td><td>${z.f}</td><td>${z.exp}</td><td>${z.cost}</td></tr>`).join('')}</tbody>`);
            }, 1000);
        };
        window.viewOldGRNByNo = async (inputNo = null) => {
            const n = inputNo || document.getElementById('old-grn').value.trim();
            if (!n) return alert("Enter Number");
            // Allow search by GRN Number OR PO Reference
            let snap = await getDocs(query(collection(db, "docs"), where("docNo", "==", n), where("type", "==", "GRN")));
            if (snap.empty) {
                snap = await getDocs(query(collection(db, "docs"), where("ref", "==", n), where("type", "==", "GRN")));
            }

            if (snap.empty) return alert("GRN Not Found");
            const d = snap.docs[0].data();
            const rows = d.items.map(x => `<tr><td>${x.code}</td><td>${x.q}</td><td>${x.f}</td><td>${x.exp}</td></tr>`).join('');
            openModal(`GRN Details: ${d.docNo}`, `
                <div class="grid grid-cols-2 gap-4 mb-4 text-sm bg-slate-50 p-4 rounded border">
                    <div><b>Date:</b> ${formatDate(d.date)}</div>
                    <div><b>PO Reference:</b> ${d.ref}</div>
                    <div><b>Invoice No:</b> ${d.invoice}</div>
                    <div><b>Status:</b> RECEIVED</div>
                </div>
                <table class="w-full mt-2 text-sm border text-left mb-6">
                    <thead class="bg-slate-100"><tr><th class="p-2">Item</th><th class="p-2">Rcv Qty</th><th class="p-2">Free</th><th class="p-2">Expiry</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `, `<button onclick="printGRN('${d.id}')" class="w-full bg-slate-800 text-white px-6 py-3 rounded-xl font-bold hover:scale-[1.02] transition shadow-lg mb-2 flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg> Print GRN</button>
            <button onclick="closeModal()" class="w-full bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold hover:bg-slate-300 transition">Close</button>`);
        };

        window.printGRN = async (id) => {
            const d = (await getDoc(doc(db, "docs", id))).data();

            // Fetch PO for Supplier Details
            const poSnap = await getDocs(query(collection(db, "docs"), where("docNo", "==", d.ref), where("type", "==", "PO")));
            const po = poSnap.empty ? { supplier: 'Unknown' } : poSnap.docs[0].data();

            // Fetch Items for Names
            const allItems = (await getDocs(collection(db, "items"))).docs.map(x => x.data());

            // Totals
            let totalQty = 0, totalFree = 0, totalTotalQty = 0, totalAmount = 0;

            const rows = d.items.map((item, idx) => {
                const iInfo = allItems.find(x => x.code === item.code) || {};
                const q = parseFloat(item.q) || 0;
                const f = parseFloat(item.f) || 0;
                const totQ = q + f;

                // Assumption: Amount = Qty * Cost (Buying Price)
                const amt = q * (parseFloat(item.cost) || 0);

                totalQty += q;
                totalFree += f;
                totalTotalQty += totQ;
                totalAmount += amt;

                return `
                <tr>
                    <td style="padding:5px; border-right:1px solid #ccc;">${idx + 1}</td>
                    <td style="padding:5px; border-right:1px solid #ccc; font-weight:bold;">${iInfo.name || 'Unknown'} (${item.code}) <br> <span style="font-weight:normal; font-size:11px;">Batch: - | Exp: ${item.exp}</span></td>
                    <td style="padding:5px; border-right:1px solid #ccc; text-align:center;">${q}</td>
                    <td style="padding:5px; border-right:1px solid #ccc; text-align:center;">${f}</td>
                    <td style="padding:5px; border-right:1px solid #ccc; text-align:center;">${totQ}</td>
                    <td style="padding:5px; border-right:1px solid #ccc; text-align:right;">${(parseFloat(item.cost) || 0).toFixed(2)}</td>
                    <td style="padding:5px; border-right:1px solid #ccc; text-align:right;">${(parseFloat(item.cost) || 0).toFixed(2)}</td>
                    <td style="padding:5px; border-right:1px solid #ccc; text-align:right;">${(parseFloat(item.sell) || 0).toFixed(2)}</td>
                    <td style="padding:5px; text-align:right;">${formatCurrency(amt).replace('Rs ', '')}</td>
                </tr>
                `;
            }).join('');

            const w = window.open('', '', 'width=900,height=800');
            w.document.write(`
                <html>
                <head>
                    <title>GRN Print - ${d.docNo}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 20px; font-size: 13px; color: #000; }
                        .header { margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        .title { font-size: 24px; font-weight: bold; margin-bottom: 15px; }
                        .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
                        .meta-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
                        table { width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 20px; }
                        th { border: 1px solid #000; padding: 5px; background: #fff; font-weight: bold; text-align: center; font-size: 12px; }
                        td { border: 1px solid #000; padding: 5px; }
                        .footer { margin-top: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
                        .totals { text-align: right; margin-bottom: 30px; }
                        .totals-row { display: flex; justify-content: flex-end; gap: 20px; font-weight: bold; margin-bottom: 5px; }
                        .auth-line { border-top: 1px dashed #000; width: 200px; padding-top: 5px; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">GRN | ${session.loc} | ${session.loc} - [DUPLICATE]</div>
                    </div>
                    
                    <div class="meta-grid">
                        <div>
                            <div class="meta-row"><span>PO No : ${d.ref}</span></div>
                            <div class="meta-row"><span>Supplier Name : ${po.supplier}</span></div>
                            <div class="meta-row"><span>GRN Invoice No : ${d.invoice}</span></div>
                        </div>
                        <div>
                             <div class="meta-row"><span>Order Status : Completed</span></div>
                             <div class="meta-row"><span>GRN No : ${d.docNo}</span></div>
                             <div class="meta-row"><span>GRN Date : ${new Date(d.date).toLocaleDateString()}</span></div>
                             <div class="meta-row"><span>Created By : ${session.user}</span></div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Medicine</th>
                                <th>Qty</th>
                                <th>Free Qty</th>
                                <th>Total Qty</th>
                                <th>Unit Price</th>
                                <th>Unit Cost</th>
                                <th>MRP</th>
                                <th>Amount(LKR)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                            <tr style="font-weight:bold; background:#f9f9f9;">
                                <td colspan="2" style="text-align:right; padding:5px;">Total</td>
                                <td style="text-align:center;">${totalQty}</td>
                                <td style="text-align:center;">${totalFree}</td>
                                <td style="text-align:center;">${totalTotalQty}</td>
                                <td colspan="3"></td>
                                <td style="text-align:right;">${formatCurrency(totalAmount).replace('Rs ', '')}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="totals">
                        <div class="totals-row"><span>Gross Amount :</span> <span>${formatCurrency(totalAmount).replace('Rs ', '')}</span></div>
                        <div class="totals-row"><span>Total Tax :</span> <span>0.000</span></div>
                        <div class="totals-row"><span>Total Discount :</span> <span>0.000</span></div>
                        <div class="totals-row" style="font-size:14px; border-top:1px solid #000; padding-top:5px;"><span>Total Payable :</span> <span>${formatCurrency(totalAmount).replace('Rs ', '')}</span></div>
                    </div>

                    <div class="footer">
                        <div>
                            <div class="auth-line">Authorized By</div>
                        </div>
                        <div style="text-align:right; font-size:11px;">
                            Printed Date : ${new Date().toLocaleString()}<br>
                            Printed By : ${session.user}
                        </div>
                    </div>
                </body>
                </html>
            `);
            w.print();
        };
        window.printGRN = async (id) => {
            try {
                const docSnap = await getDoc(doc(db, "docs", id));
                if (!docSnap.exists()) return alert("GRN Doc Not Found");
                const d = docSnap.data();

                // Fetch PO for Supplier Details
                let po = { supplier: 'Direct/Unknown' };
                if (d.ref) {
                    const poSnap = await getDocs(query(collection(db, "docs"), where("docNo", "==", d.ref), where("type", "==", "PO")));
                    if (!poSnap.empty) po = poSnap.docs[0].data();
                }

                // Fetch Items for Names - fetch ALL to be safe or optimize? Fetching all is safer for small catalogs.
                const allItems = (await getDocs(collection(db, "items"))).docs.map(x => x.data());

                // Totals
                let totalQty = 0, totalFree = 0, totalTotalQty = 0, totalAmount = 0;

                const rows = d.items.map((item, idx) => {
                    const iInfo = allItems.find(x => x.code === item.code) || { name: 'Unknown Item' };
                    const q = parseFloat(item.q) || 0;
                    const f = parseFloat(item.f) || 0;
                    const totQ = q + f;
                    const unitCost = parseFloat(item.cost) || 0;
                    const sellPrice = parseFloat(item.sell) || 0;

                    // Amount calculation (usually Qty * Cost)
                    const amt = q * unitCost;

                    totalQty += q;
                    totalFree += f;
                    totalTotalQty += totQ;
                    totalAmount += amt;

                    return `
                    <tr>
                        <td style="padding:5px; border-right:1px solid #ccc;">${idx + 1}</td>
                        <td style="padding:5px; border-right:1px solid #ccc; font-weight:bold;">${iInfo.name} (${item.code}) <br> <span style="font-weight:normal; font-size:11px;">Exp: ${item.exp}</span></td>
                        <td style="padding:5px; border-right:1px solid #ccc; text-align:center;">${q}</td>
                        <td style="padding:5px; border-right:1px solid #ccc; text-align:center;">${f}</td>
                        <td style="padding:5px; border-right:1px solid #ccc; text-align:center;">${totQ}</td>
                        <td style="padding:5px; border-right:1px solid #ccc; text-align:right;">${formatCurrency(unitCost).replace('Rs ', '')}</td>
                        <td style="padding:5px; border-right:1px solid #ccc; text-align:right;">${formatCurrency(unitCost).replace('Rs ', '')}</td>
                        <td style="padding:5px; border-right:1px solid #ccc; text-align:right;">${formatCurrency(sellPrice).replace('Rs ', '')}</td>
                        <td style="padding:5px; text-align:right;">${formatCurrency(amt).replace('Rs ', '')}</td>
                    </tr>
                    `;
                }).join('');

                const w = window.open('', '', 'width=950,height=900');
                w.document.write(`
                    <html>
                    <head>
                        <title>GRN Print - ${d.docNo}</title>
                        <style>
                            body { font-family: 'Times New Roman', serif; padding: 40px; font-size: 13px; color: #000; }
                            .header { margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 15px; }
                            .title { font-size: 26px; font-weight: bold; margin-bottom: 5px; text-transform:uppercase; color:#000; }
                            .subtitle { font-size: 16px; font-weight: bold; color:#555; margin-bottom: 15px; }
                            .meta-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; border: 1px solid #eee; padding: 15px; }
                            .meta-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #ddd; padding-bottom: 2px; }
                            table { width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 20px; }
                            th { border: 1px solid #000; padding: 8px; background: #f0f0f0; font-weight: bold; text-align: center; font-size: 12px; }
                            td { border: 1px solid #000; padding: 8px; }
                            .totals { text-align: right; margin-bottom: 40px; float: right; width: 300px; }
                            .totals-row { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px; }
                            .footer { margin-top: 100px; display: flex; justify-content: space-between; align-items: flex-end; clear: both; }
                            .auth-box { text-align: center; }
                            .auth-line { border-top: 1px solid #000; width: 200px; padding-top: 5px; font-weight: bold; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="title">Goods Received Note</div>
                            <div class="subtitle">${session.loc} | IMS ELITE</div>
                        </div>
                        
                        <div class="meta-grid">
                            <div>
                                <div class="meta-row"><span style="color:#666">PO Reference</span> <b>${d.ref}</b></div>
                                <div class="meta-row"><span style="color:#666">Supplier</span> <b>${po.supplier}</b></div>
                                <div class="meta-row"><span style="color:#666">Invoice No</span> <b>${d.invoice}</b></div>
                            </div>
                            <div>
                                 <div class="meta-row"><span style="color:#666">GRN Number</span> <b>${d.docNo}</b></div>
                                 <div class="meta-row"><span style="color:#666">Date</span> <b>${formatDate(d.date)}</b></div>
                                 <div class="meta-row"><span style="color:#666">Received By</span> <b>${session.user}</b></div>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Item Description</th>
                                    <th>Qty</th>
                                    <th>Free</th>
                                    <th>Total</th>
                                    <th>Unit Cost</th>
                                    <th>Unit Price</th>
                                    <th>MRP</th>
                                    <th>Net Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>

                        <div class="totals">
                            <div class="totals-row"><span>Gross Amount:</span> <span>${formatCurrency(totalAmount)}</span></div>
                            <div class="totals-row"><span>Total Tax:</span> <span>0.00</span></div>
                            <div class="totals-row" style="font-size:16px; border-top:2px solid #000; padding-top:10px;"><span>NET TOTAL:</span> <span>${formatCurrency(totalAmount)}</span></div>
                        </div>

                        <div class="footer">
                            <div class="auth-box">
                                <div class="auth-line">Store Keeper</div>
                            </div>
                            <div class="auth-box">
                                <div class="auth-line">Authorized Signature</div>
                            </div>
                            <div style="text-align:right; font-size:11px; color:#888;">
                                Generated: ${new Date().toLocaleString()}
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                w.print();
            } catch (e) {
                console.error(e);
                alert("Print Error: " + e.message);
            }
        };

        // === 9.5 PRN (Purchase Return) ===
        async function loadPRN() {
            const raw = await getDocs(collection(db, "docs"));
            const prnDocs = raw.docs.filter(d => d.data().type === 'PRN').sort((a, b) => new Date(b.data().date) - new Date(a.data().date));

            document.getElementById('app').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-black text-2xl text-slate-800">Purchase Returns (PRN)</h3>
                        <p class="text-slate-500 text-sm">Return stock to suppliers</p>
                    </div>
                    <button onclick="createPRN()" class="bg-rose-600 hover:bg-rose-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-rose-200 transition transform active:scale-95 flex items-center gap-2">
                        <span>+ New Return</span>
                    </button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100 uppercase text-xs font-black text-slate-400 tracking-wider">
                            <tr><th class="p-4">PRN Number</th><th class="p-4">Supplier</th><th class="p-4">Date</th><th class="p-4">Items</th><th class="p-4">Status</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                             ${prnDocs.map(d => `
                            <tr>
                                <td class="p-4 font-mono font-bold text-rose-600">${d.data().docNo}</td>
                                <td class="p-4 font-bold text-slate-700">${d.data().supplier}</td>
                                <td class="p-4 text-sm">${formatDate(d.data().date)}</td>
                                <td class="p-4 text-sm">${d.data().items.length} Items</td>
                                <td class="p-4"><span class="bg-rose-100 text-rose-700 px-2 py-1 rounded text-[10px] font-black uppercase">RETURNED</span></td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                     ${prnDocs.length === 0 ? '<div class="p-12 text-center text-slate-400 italic">No Returns found.</div>' : ''}
                </div>
            `;
        }

        window.createPRN = async () => {
            const locs = await getDocs(collection(db, "suppliers"));
            const items = await getDocs(collection(db, "items"));
            window.prnItems = [];

            const supOpt = locs.docs.map(l => `<option value="${l.data().name}">${l.data().name}</option>`).join('');
            const itemOpt = items.docs.map(i => `<option value="${i.data().code}" data-name="${i.data().name}">${i.data().name}</option>`).join('');

            openModal("New Purchase Return", `
                <div class="grid gap-4">
                    <div><label class="font-bold text-xs uppercase text-slate-400">Select Supplier</label>
                    <select id="prn-sup" class="w-full p-2 border rounded font-bold bg-slate-50">${supOpt}</select></div>
                    
                    <div class="bg-slate-50 p-3 rounded border">
                         <div class="mb-2 font-bold text-sm text-slate-500">Pick Stock to Return</div>
                         <div class="flex gap-2 mb-2">
                             <select id="prn-item" class="flex-1 p-2 text-sm border rounded" onchange="loadPRNBatches()">${itemOpt}</select>
                             <select id="prn-batch" class="flex-1 p-2 text-sm border rounded"><option>Select Item First</option></select>
                         </div>
                         <div class="flex gap-2">
                             <input id="prn-qty" type="number" placeholder="Ret Qty" class="flex-1 p-2 text-sm border rounded">
                             <input id="prn-free" type="number" placeholder="Free Qty" class="flex-1 p-2 text-sm border rounded">
                             <button onclick="addPRNItem()" class="bg-rose-600 text-white px-4 rounded font-bold">Add</button>
                         </div>
                    </div>
                    <div id="prn-list" class="space-y-2 max-h-40 overflow-auto"></div>
                </div>
             `, `<button onclick="savePRNPrep()" class="bg-rose-600 text-white px-6 py-2 rounded font-bold shadow-lg w-full">Process Return</button>`);

            setTimeout(loadPRNBatches, 100);
        };

        window.loadPRNBatches = async () => {
            const c = document.getElementById('prn-item').value;
            const s = await getDocs(query(collection(db, "stocks"), where("itemCode", "==", c), where("loc", "==", session.loc)));
            const sel = document.getElementById('prn-batch');
            sel.innerHTML = s.docs.filter(d => d.data().qty > 0).map(d => `<option value="${d.id}" data-max="${d.data().qty}">Exp: ${d.data().exp} (Avl: ${d.data().qty})</option>`).join('');
        };

        window.addPRNItem = () => {
            const b = document.getElementById('prn-batch');
            if (!b.value) return alert("No Batch Selected");
            const q = parseFloat(document.getElementById('prn-qty').value) || 0;
            const f = parseFloat(document.getElementById('prn-free').value) || 0;
            const max = parseFloat(b.options[b.selectedIndex].dataset.max);

            if (q + f <= 0) return alert("Qty required");
            if (q + f > max) return alert("Insufficient Stock in Batch");

            const iSel = document.getElementById('prn-item');
            const name = iSel.options[iSel.selectedIndex].dataset.name;
            const exp = b.options[b.selectedIndex].text.split(' ')[1];

            window.prnItems.push({ code: iSel.value, name, qty: q, free: f, batchId: b.value, exp });
            renderPRNList();
        };

        window.renderPRNList = () => {
            document.getElementById('prn-list').innerHTML = window.prnItems.map((x, i) => `
                <div class="flex justify-between items-center bg-white p-2 border rounded text-sm">
                    <div><b>${x.name}</b> <span class="text-xs text-slate-500">${x.exp}</span></div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-rose-600">-${x.qty} (+${x.free} free)</span>
                        <button onclick="window.prnItems.splice(${i},1);renderPRNList()" class="text-red-500 font-bold">&times;</button>
                    </div>
                </div>`).join('');
        };

        window.savePRNPrep = () => {
            if (window.prnItems.length === 0) return alert("No Items");
            const s = document.getElementById('prn-sup').value;
            confirmAction("Confirm Return?", "savePRNExec", s);
        };

        window.savePRNExec = async (sup) => {
            const id = await generateID('PRN', 'docs');
            const batch = writeBatch(db);

            for (let x of window.prnItems) {
                // Deduct Stock
                const ref = doc(db, "stocks", x.batchId);
                const sDoc = await getDoc(ref);
                if (sDoc.exists()) {
                    batch.update(ref, { qty: sDoc.data().qty - (x.qty + x.free) });
                }
                // Log
                await logHistory(x.code, 'PRN', -(x.qty + x.free), id, session.loc, sup);
            }

            // Save Doc
            const dRef = doc(collection(db, "docs"));
            // Store simple items array
            const cleanItems = window.prnItems.map(x => ({ code: x.code, name: x.name, q: x.qty, f: x.free, exp: x.exp }));
            batch.set(dRef, { docNo: id, type: 'PRN', supplier: sup, items: cleanItems, date: new Date().toISOString() });

            await batch.commit();
            loadPRN();
            showCreatedDoc(id, 'Purchase Return');
        };
        // === 10. TRANSFER OUT ===
        async function loadTransferOut() {
            const locs = await getDocs(collection(db, "locations"));
            const items = await getDocs(collection(db, "items"));

            // Simple query first, then filter client side to ensure data shows up even if index is missing
            const raw = await getDocs(collection(db, "docs"));

            // Filter: 
            // - As Sender: doc.fromLoc == session.loc
            // - As Receiver: doc.toLoc == session.loc (technically Transfer In covers this, but maybe they want to see history here too?)
            // Request: "transfers only can send location and receice locations other locations cannot use that transfers"
            // So: FROM me OR TO me.
            const filtered = raw.docs.filter(d => {
                const data = d.data();
                return data.type === 'TRANSFER' && (session.isAdmin || data.fromLoc === session.loc || data.toLoc === session.loc);
            });
            const outSnap = { docs: filtered.sort((a, b) => new Date(b.data().date) - new Date(a.data().date)) };

            document.getElementById('app').innerHTML = `
                 <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-black text-2xl text-slate-800">Transfer Out</h3>
                        <p class="text-slate-500 text-sm">Transfers sent from <b>${session.loc}</b></p>
                    </div>
                    <div class="flex gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                        <input id="tr-find" placeholder="Transfer #..." class="border-none bg-transparent p-2 text-sm w-48 focus:ring-0 font-medium">
                        <button onclick="viewOldTrByNo()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 rounded-lg font-bold text-xs uppercase tracking-wide transition">Find</button>
                    </div>
                     <button onclick="createTransferOut()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-blue-200 transition transform active:scale-95 flex items-center gap-2">
                        <span>+ New Transfer</span>
                    </button>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100 uppercase text-xs font-black text-slate-400 tracking-wider">
                            <tr><th class="p-4">TR Number</th><th class="p-4">To Location</th><th class="p-4">Status</th><th class="p-4">Date</th><th class="p-4">Actions</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-50">
                            ${outSnap.docs.map(d => `
                            <tr class="hover:bg-slate-50 transition-colors group">
                                <td class="p-4 font-mono font-bold text-blue-600 group-hover:text-blue-700">${d.data().docNo}</td>
                                <td class="p-4 font-bold text-slate-700">${d.data().toLoc}</td>
                                <td class="p-4">
                                     <span class="px-2.5 py-1 rounded-md text-[10px] font-black tracking-wide uppercase ${d.data().status === 'TRANSIT' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">
                                        ${d.data().status}
                                    </span>
                                </td>
                                <td class="p-4 text-sm text-slate-500 font-medium">${formatDate(d.data().date)}</td>
                                <td class="p-4">
                                    <button onclick="viewOldTr('${d.id}')" class="text-slate-400 hover:text-blue-600 font-bold text-xs bg-transparent p-2 rounded hover:bg-blue-50 transition">View Details</button>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                     ${outSnap.docs.length === 0 ? '<div class="p-12 text-center text-slate-400 italic">No Sent Transfers found.</div>' : ''}
                </div>`;
            window.trItems = [];
        }

        window.createTransferOut = async () => {
            const locs = await getDocs(collection(db, "locations"));
            const items = await getDocs(collection(db, "items"));
            window.trItems = [];

            const locOpt = locs.docs.filter(l => l.data().name !== session.loc).map(l => `<option>${l.data().name}</option>`).join('');
            // Store Name and Cost in attributes
            const itemOpt = items.docs.map(i => `<option value="${i.data().code}" data-name="${i.data().name}" data-cost="${i.data().cost}" data-pack="${i.data().packSize || '1'}">${i.data().name} (${i.data().code})</option>`).join('');

            openModal("New Transfer Out", `
                <div class="grid gap-4">
                    <div><label class="font-bold text-xs uppercase text-slate-400">Destination Location</label>
                    <select id="tr-dest" class="w-full p-2 border rounded font-bold bg-slate-50">${locOpt}</select></div>
                    
                    <div class="bg-slate-50 p-3 rounded border">
                         <div class="mb-2 font-bold text-sm text-slate-500">Add Items</div>
                         <div class="flex gap-2 mb-2">
                             <select id="tr-item" class="flex-1 p-2 text-sm border rounded" onchange="loadTrBatches()">${itemOpt}</select>
                             <select id="tr-batch" class="flex-1 p-2 text-sm border rounded"><option>Select Item First</option></select>
                         </div>
                         <div class="flex gap-2">
                             <input id="tr-qty" type="number" placeholder="Qty" class="flex-1 p-2 text-sm border rounded">
                             <button onclick="addTrItem()" class="bg-slate-800 text-white px-4 rounded font-bold">+</button>
                         </div>
                    </div>
                    <div id="tr-list" class="space-y-2 max-h-40 overflow-auto"></div>
                </div>
             `, `<button onclick="saveTrPrep()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold shadow-lg">Send Transfer</button>`);

            setTimeout(loadTrBatches, 100);
        };

        window.viewOldTrByNo = async () => {
            const n = document.getElementById('tr-find').value.trim();
            if (!n) return alert("Enter Number");
            const snap = await getDocs(query(collection(db, "docs"), where("docNo", "==", n), where("type", "==", "TRANSFER")));
            if (snap.empty) return alert("Transfer Not Found");
            viewOldTr(snap.docs[0].id);
        };

        window.viewOldTr = async (id) => {
            const d = (await getDoc(doc(db, "docs", id))).data();
            const rows = d.items.map(x => `<tr>
                <td class="p-2">${x.name || ''} <span class="text-xs text-slate-500">(${x.code})</span></td>
                <td class="p-2">${x.pack || '-'}</td>
                <td class="p-2 font-bold">${x.qty}</td>
                <td class="p-2">${x.exp || '-'}</td>
                <td class="p-2 text-right">${formatCurrency(x.cost || 0)}</td>
                <td class="p-2 text-right font-bold">${formatCurrency((x.cost || 0) * x.qty)}</td>
            </tr>`).join('');

            openModal(`Transfer Details: ${d.docNo}`,
                `<div class="mb-4 grid grid-cols-2 gap-2 text-sm bg-slate-50 p-3 rounded border">
                    <div><b>From:</b> ${d.fromLoc}</div>
                    <div><b>To:</b> ${d.toLoc}</div>
                    <div><b>Status:</b> ${d.status}</div>
                    <div><b>Date:</b> ${formatDate(d.date)}</div>
                </div>
                <table class="w-full text-sm border text-left">
                    <thead class="bg-slate-100"><tr><th class="p-2">Item</th><th class="p-2">Pack</th><th class="p-2">Qty</th><th class="p-2">Exp</th><th class="p-2 text-right">Cost</th><th class="p-2 text-right">Value</th></tr></thead>
                    <tbody>${rows}</tbody>
                    <tfoot><tr class="bg-slate-100 font-bold"><td colspan="5" class="p-2 text-right">Total Value:</td><td class="p-2 text-right">${formatCurrency(d.items.reduce((a, c) => a + ((c.cost || 0) * c.qty), 0))}</td></tr></tfoot>
                </table>`,
                `<button onclick="closeModal()" class="btn bg-slate-200 px-4 py-2 font-bold rounded">Close</button>`);
        };

        window.loadTrBatches = async () => {
            const c = document.getElementById('tr-item').value;
            const s = await getDocs(query(collection(db, "stocks"), where("itemCode", "==", c), where("loc", "==", session.loc)));
            const sel = document.getElementById('tr-batch');
            sel.innerHTML = s.docs.filter(d => d.data().qty > 0).map(d => `<option value="${d.id}" data-max="${d.data().qty}">Exp: ${d.data().exp} (Avl: ${d.data().qty})</option>`).join('');
        };

        window.addTrItem = () => {
            const b = document.getElementById('tr-batch');
            const iSel = document.getElementById('tr-item');
            if (!b.value) return alert("No Stock");

            const max = parseFloat(b.options[b.selectedIndex].dataset.max);
            const q = parseFloat(document.getElementById('tr-qty').value);
            const c = iSel.value;
            const name = iSel.options[iSel.selectedIndex].dataset.name;
            const cost = parseFloat(iSel.options[iSel.selectedIndex].dataset.cost) || 0;
            const exp = b.options[b.selectedIndex].text.split(' ')[1]; // simple parse

            if (!q || q > max) return alert("Invalid Qty");

            window.trItems.push({ code: c, name, qty: q, batchId: b.value, exp, cost, pack: iSel.options[iSel.selectedIndex].dataset.pack });

            document.getElementById('tr-list').innerHTML = window.trItems.map((x, i) => `
                <div class="flex justify-between items-center bg-white p-2 border rounded shadow-sm text-sm">
                    <div>
                        <div class="font-bold">${x.name}</div>
                        <div class="text-xs text-slate-500">Code: ${x.code} | Pack: ${x.pack} | Exp: ${x.exp}</div>
                    </div>
                    <div class="flex gap-4 items-center">
                        <div class="text-right">
                             <div class="font-bold text-slate-700">${formatCurrency(x.cost * x.qty)}</div>
                             <div class="text-[10px] text-slate-400">@ ${formatCurrency(x.cost)}</div>
                        </div>
                        <span class="font-black text-lg text-blue-600">${x.qty}</span>
                        <div onclick="window.trItems.splice(${i},1);this.closest('.flex').parentElement.remove()" class="text-red-500 font-bold px-2 cursor-pointer">&times;</div>
                    </div>
                </div>`).join('');
        };
        window.saveTrPrep = () => {
            if (window.trItems.length === 0) return alert("No Items");
            const dest = document.getElementById('tr-dest').value;
            if (!dest) return alert("Destination Required");
            confirmAction("Send Transfer?", "saveTrExec", dest);
        };
        window.saveTrExec = async (dest) => {
            try {
                const id = await generateID('TR-OUT', 'docs');
                // Destination passed as arg


                if (!dest) throw new Error("Destination Location Required");

                const batch = writeBatch(db);
                // Deduct Items
                for (let x of window.trItems) {
                    const ref = doc(db, "stocks", x.batchId);
                    const snap = await getDoc(ref);
                    if (snap.exists()) batch.update(ref, { qty: snap.data().qty - x.qty });
                    // Log but don't await to block, or ensure it doesn't fail batch
                }

                const dRef = doc(collection(db, "docs"));
                // Explicitly saving toLoc and fromLoc
                // Ensure no undefined values
                const cleanItems = window.trItems.map(x => ({
                    code: x.code, name: x.name, qty: x.qty, batchId: x.batchId,
                    exp: x.exp || '', cost: x.cost || 0, pack: x.pack || '1'
                }));

                batch.set(dRef, {
                    docNo: id, type: 'TRANSFER', fromLoc: session.loc, toLoc: dest,
                    items: cleanItems, status: 'TRANSIT', date: new Date().toISOString()
                });

                await batch.commit();

                // Log History separately to avoid blocking/failures in batch
                for (let x of window.trItems) {
                    await logHistory(x.code, 'TR-OUT', -x.qty, id, session.loc, dest);
                }

                loadTransferOut();
                showCreatedDoc(id, 'Transfer Out');
            } catch (e) {
                console.error(e);
                alert("Error saving Transfer: " + e.message);
            }
        };

        // === 11. TRANSFER IN ===
        async function loadTransferIn() {
            // Fetch ALL docs, then filter Client Side to be safe
            const raw = await getDocs(collection(db, "docs"));

            // Filter manually
            const transferDocs = raw.docs.filter(d => d.data().type === 'TRANSFER');

            // Filter for Incoming: what is sent TO me (toLoc == session.loc)
            // Pending: Status TRANSIT
            // History: Status RECEIVED

            const pending = transferDocs.filter(d => d.data().status === 'TRANSIT' && (session.isAdmin || d.data().toLoc === session.loc));
            const hist = transferDocs.filter(d => d.data().status === 'RECEIVED' && (session.isAdmin || d.data().toLoc === session.loc))
                .sort((a, b) => new Date(b.data().date) - new Date(a.data().date)).slice(0, 20);

            document.getElementById('app').innerHTML = `
                 <div class="max-w-5xl mx-auto">
                     <div class="flex justify-between items-end mb-6">
                        <div>
                            <h3 class="font-black text-xl text-slate-800">Incoming Transfers</h3>
                             <p class="text-slate-500 text-sm">Transfers sent to <b>${session.loc}</b></p>
                        </div>
                         <div class="flex gap-2 bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                             <input id="tr-in-find" placeholder="Scan Transfer #..." class="border-none bg-transparent p-2 text-sm w-48 focus:ring-0 font-medium">
                             <button onclick="viewRecvTrByNo()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 rounded-lg font-bold text-xs uppercase tracking-wide transition">Find</button>
                         </div>
                     </div>
                     
                     <!-- Pending Section -->
                     <div class="bg-orange-50 rounded-2xl border border-orange-100 p-6 mb-8 overflow-hidden relative">
                         <div class="absolute top-0 right-0 p-4 opacity-10"><svg class="w-32 h-32 text-orange-500" fill="currentColor" viewBox="0 0 24 24"><path d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg></div>
                         <h3 class="font-bold text-lg mb-4 text-orange-800 flex items-center gap-2">
                            <span class="bg-orange-200 text-orange-700 w-6 h-6 rounded flex items-center justify-center text-xs ml-1">${pending.length}</span>
                            Pending Receipts
                         </h3>
                         <div class="bg-white/50 backdrop-blur rounded-xl border border-orange-100 overflow-hidden">
                             <table class="w-full text-left">
                                <thead class="bg-orange-100/50 text-orange-900 uppercase text-[10px] font-bold tracking-wider"><tr><th class="p-3">TR#</th><th class="p-3">From Location</th><th class="p-3">Date</th><th class="p-3">Action</th></tr></thead>
                                <tbody class="divide-y divide-orange-100">${pending.map(d => `
                                    <tr class="hover:bg-orange-50 transition">
                                        <td class="p-3 font-mono font-bold text-orange-700">${d.data().docNo}</td>
                                        <td class="p-3 font-bold text-slate-700">${d.data().fromLoc}</td>
                                        <td class="p-3 text-sm text-slate-600">${formatDate(d.data().date)}</td>
                                        <td class="p-3"><button onclick="viewRecvTr('${d.id}')" class="bg-slate-800 hover:bg-black text-white px-3 py-1.5 rounded-lg font-bold text-xs shadow-lg hover:scale-105 transition flex items-center gap-2"><span>Receive</span><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg></button></td>
                                    </tr>`).join('')}</tbody>
                             </table>
                             ${pending.length === 0 ? '<div class="text-center text-orange-400 py-6 text-sm font-medium">No Pending Transfers</div>' : ''}
                         </div>
                     </div>
                     
                     <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                         <h3 class="font-bold text-lg mb-4 text-slate-700">Received History</h3>
                         <div class="overflow-x-auto">
                              <table class="w-full text-left">
                                <thead class="bg-slate-50 uppercase text-[10px] font-bold text-slate-400"><tr><th class="p-3">TR#</th><th class="p-3">From Location</th><th class="p-3">Date</th><th class="p-3">Status</th></tr></thead>
                                <tbody class="divide-y divide-slate-50">${hist.map(d => `
                                    <tr class="hover:bg-slate-50 transition">
                                        <td class="p-3 font-mono font-bold text-slate-600">${d.data().docNo}</td>
                                        <td class="p-3 font-bold text-slate-700">${d.data().fromLoc}</td>
                                        <td class="p-3 text-sm text-slate-500">${formatDate(d.data().date)}</td>
                                        <td class="p-3"><span class="bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wide">RECEIVED</span></td>
                                    </tr>`).join('')}</tbody>
                             </table>
                         </div>
                     </div>
                 </div>`;
        }

        window.viewRecvTrByNo = async () => {
            const n = document.getElementById('tr-in-find').value.trim();
            if (!n) return alert("Enter Number");
            const snap = await getDocs(query(collection(db, "docs"), where("docNo", "==", n), where("type", "==", "TRANSFER")));
            if (snap.empty) return alert("Transfer Not Found");
            viewRecvTr(snap.docs[0].id);
        };

        window.viewRecvTr = async (id) => {
            const d = (await getDoc(doc(db, "docs", id))).data();
            const rows = d.items.map(x => `<tr>
                 <td class="p-2">${x.name || ''} <span class="text-xs text-slate-500">(${x.code})</span></td>
                 <td class="p-2 font-bold">${x.qty}</td>
                 <td class="p-2">${x.exp || '-'}</td>
                 <td class="p-2 text-right">${formatCurrency(x.cost || 0)}</td>
                 <td class="p-2 text-right font-bold">${formatCurrency((x.cost || 0) * x.qty)}</td>
              </tr>`).join('');

            openModal(`Receive Transfer: ${d.docNo}`, `
                  <div class="mb-4 bg-orange-50 p-4 rounded border border-orange-200">
                      <div class="grid grid-cols-2 gap-4 text-sm">
                          <div><b>From Location:</b> ${d.fromLoc}</div>
                          <div><b>To (You):</b> ${d.toLoc}</div>
                          <div><b>Sent Date:</b> ${formatDate(d.date)}</div>
                      </div>
                  </div>
                  <div class="mb-2 font-bold text-xs uppercase text-slate-400">Items to Receive</div>
                  <table class="w-full text-sm border mb-4 text-left">
                      <thead class="bg-slate-100"><tr><th class="p-2">Item</th><th class="p-2">Qty</th><th class="p-2">Expiry</th><th class="p-2 text-right">Cost</th><th class="p-2 text-right">Value</th></tr></thead>
                      <tbody>${rows}</tbody>
                  </table>
               `, `<button onclick="confirmAction('Confirm Receipt of Stock?','execRecvTr','${id}')" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:scale-[1.02] transition">Confirm & Add Stock</button>`);
        };
        window.execRecvTr = async (id) => {
            const ref = doc(db, "docs", id);
            const d = (await getDoc(ref)).data();
            const batch = writeBatch(db);

            d.items.forEach(x => {
                const sRef = doc(collection(db, "stocks"));
                // We add as new batch to keep expiry info
                batch.set(sRef, { itemCode: x.code, loc: session.loc, qty: x.qty, exp: x.exp || 'TRANSFER', date: new Date().toISOString() });
                // Log
                // logHistory fn is async so let's skip await inside loop or do separate
            });

            // Update Doc
            batch.update(ref, { status: 'RECEIVED' });
            await batch.commit();

            // Log separately
            for (let x of d.items) await logHistory(x.code, 'TR-IN', x.qty, d.docNo, d.fromLoc, session.loc);

            alert("Transfer Received!");
            loadTransferIn();
            window.closeModal();
        };

        // === 12. VERIFICATION ===
        async function loadVerification() {
            const items = await getDocs(collection(db, "items"));
            document.getElementById('app').innerHTML = `
             <div class="max-w-lg mx-auto mt-10">
                    <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
                        <div class="flex items-center gap-4 mb-8">
                             <div class="bg-indigo-100 p-3 rounded-xl text-indigo-600"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg></div>
                             <div>
                                 <h3 class="font-black text-2xl text-slate-800">Stock Adjustment</h3>
                                 <p class="text-slate-400 text-sm">Correct stock discrepancies</p>
                             </div>
                        </div>
                        
                        <div class="space-y-5">
                            <div><label class="block font-bold text-xs uppercase text-slate-400 mb-1">Select Item</label>
                            <select id="v-i" class="w-full p-3 border border-slate-200 bg-slate-50 rounded-xl font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none" onchange="loadVerBatches()">${items.docs.map(i => `<option value="${i.data().code}">${i.data().name}</option>`).join('')}</select></div>
                            
                            <div><label class="block font-bold text-xs uppercase text-slate-400 mb-1">Select Batch</label>
                            <select id="v-b" class="w-full p-3 border border-slate-200 bg-slate-50 rounded-xl font-medium text-sm outline-none"><option>Loading...</option></select></div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block font-bold text-xs uppercase text-slate-400 mb-1">Adjust Qty (+/-)</label>
                                <input id="v-q" type="number" class="w-full p-3 border border-slate-200 rounded-xl text-center font-bold" placeholder="-5"></div>
                                
                                <div><label class="block font-bold text-xs uppercase text-slate-400 mb-1">Reason</label>
                                <input id="v-r" class="w-full p-3 border border-slate-200 rounded-xl" placeholder="Damaged..."></div>
                            </div>
                            
                            <button onclick="saveVerPrep()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-xl font-black text-lg shadow-lg shadow-indigo-200 transition transform active:scale-95 mt-2">Post Adjustment</button>
                        </div>
                    </div>
                </div>`;
            window.loadVerBatches();
        }
        window.loadVerBatches = async () => {
            const c = document.getElementById('v-i').value;
            // FIXED: Proper query syntax
            const s = await getDocs(query(collection(db, "stocks"), where("itemCode", "==", c), where("loc", "==", session.loc)));
            const sel = document.getElementById('v-b');
            sel.innerHTML = s.docs.map(d => `<option value="${d.id}">Exp: ${d.data().exp} (Qty: ${d.data().qty})</option>`).join('') + `<option value="NEW">--New Batch--</option>`;
        };
        window.saveVerPrep = () => {
            const bid = document.getElementById('v-b').value;
            const q = document.getElementById('v-q').value;
            const c = document.getElementById('v-i').value;
            const r = document.getElementById('v-r').value;
            if (!q) return alert("Qty Required");
            confirmAction("Adjust Stock?", "saveVerExec", c, bid, q, r);
        };

        window.saveVerExec = async (c, bid, qStr, r) => {
            let exp = 'AUDIT';
            if (bid === 'NEW') {
                exp = prompt("Enter Expiry (YYYY-MM-DD) for new batch:");
                if (!exp) return;
            }

            const q = parseFloat(qStr);
            // const c = ... passed as arg


            if (bid === 'NEW') {
                await addDoc(collection(db, "stocks"), { itemCode: c, loc: session.loc, qty: q, exp, date: new Date().toISOString() });
            } else {
                const ref = doc(db, "stocks", bid);
                const d = (await getDoc(ref)).data();
                await updateDoc(ref, { qty: d.qty + q });
            }

            await logHistory(c, 'ADJUST', q, 'ADJ', session.loc);
            alert("Adjusted");
            loadVerification();
            window.closeModal();
        };

        // === 13. BILLING / POS ===
        async function loadBilling() {
            const items = await getDocs(collection(db, "items"));
            window.cart = [];

            // Enhanced Billing UI
            document.getElementById('app').innerHTML = `
            <div class="flex flex-col lg:flex-row h-[calc(100vh-120px)] gap-6">
                 <!-- LEFT: Product Selection -->
                 <div class="w-full lg:w-2/3 flex flex-col gap-4">
                     
                     <!-- Search & Quick Add -->
                     <div class="card p-4 flex gap-3 items-center bg-white shadow-sm border border-slate-200">
                         <div class="flex-1 relative">
                             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                 <svg class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
                             </div>
                             <select id="pos-item" class="w-full pl-10 p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none">
                                 <option disabled selected>Select Product...</option>
                                 ${items.docs.map(i => `<option value="${i.data().code}" data-sel="${i.data().sell}" data-name="${i.data().name}">${i.data().name} ‚Äî Rs ${i.data().sell}</option>`).join('')}
                             </select>
                         </div>
                         <input id="pos-qty" type="number" value="1" min="1" class="w-24 p-3 border border-slate-200 rounded-xl font-bold text-center text-lg shadow-sm" placeholder="Qty">
                         <button onclick="addToCart()" class="bg-blue-600 hover:bg-blue-700 text-white w-14 h-14 rounded-xl flex items-center justify-center font-black text-2xl shadow-lg transition transform active:scale-95">+</button>
                     </div>

                     <!-- Cart Items List -->
                     <div class="card flex-1 overflow-hidden flex flex-col bg-white shadow-sm border border-slate-200">
                         <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                             <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Current Order</span>
                             <span class="text-xs font-bold text-slate-400" id="cart-count">0 Items</span>
                         </div>
                         <div id="cart-list" class="flex-1 overflow-auto p-2 space-y-2 custom-scrollbar">
                             <div class="h-full flex flex-col items-center justify-center text-slate-300">
                                 <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                 <p class="font-medium text-sm">Cart is empty</p>
                             </div>
                         </div>
                     </div>
                 </div>

                 <!-- RIGHT: Totals & Checkout -->
                 <div class="w-full lg:w-1/3 flex flex-col gap-4">
                     <div class="card p-6 bg-slate-900 text-white flex-1 flex flex-col shadow-2xl relative overflow-hidden">
                         <!-- Decorative gradient -->
                         <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-blob"></div>
                         
                         <div class="relative z-10 flex flex-col h-full">
                             <div class="flex-1 flex flex-col justify-center items-center text-center">
                                 <div class="text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mb-4">Total Payable</div>
                                 <div class="text-5xl lg:text-6xl font-black tracking-tighter mb-2 text-transparent bg-clip-text bg-gradient-to-r from-green-300 to-emerald-500">
                                     <span class="text-3xl font-bold text-slate-500 align-top mr-1">Rs</span><span id="pos-total">0.00</span>
                                 </div>
                                 <div class="text-slate-500 text-sm font-medium" id="pos-subtotal">Subtotal: Rs 0.00</div>
                             </div>

                             <div class="mt-8 space-y-4">
                                 <div class="bg-white/10 p-1 rounded-xl flex items-center border border-white/10">
                                     <span class="text-slate-400 px-3 font-bold text-sm">DISC</span>
                                     <input id="pos-disc" type="number" placeholder="0.00" class="bg-transparent border-none text-right text-white font-bold w-full focus:ring-0 placeholder-slate-600" onkeyup="renderCart()">
                                 </div>

                                 <button onclick="checkoutPrep()" class="group w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white p-5 rounded-2xl font-black text-xl uppercase tracking-wider shadow-lg shadow-green-900/50 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-3">
                                     <span>Checkout</span>
                                     <svg class="w-6 h-6 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                                 </button>
                             </div>
                         </div>
                     </div>
                     
                     <button onclick="viewOldBills()" class="card p-4 flex items-center justify-center gap-2 font-bold text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition border border-slate-200">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                         Recent Bills
                     </button>
                 </div>
            </div> `;
        }
        window.addToCart = () => {
            const el = document.getElementById('pos-item');
            const qty = parseFloat(document.getElementById('pos-qty').value);
            const price = parseFloat(el.options[el.selectedIndex].dataset.sel);
            const name = el.options[el.selectedIndex].dataset.name;
            const code = el.value;

            window.cart.push({ code, name, price, qty });
            window.renderCart();
        };
        window.renderCart = () => {
            let total = 0;
            const disc = parseFloat(document.getElementById('pos-disc').value) || 0;

            const html = window.cart.map((c, i) => {
                const sub = c.qty * c.price;
                total += sub;
                return `<div class="flex justify-between items-center bg-slate-50 hover:bg-slate-100 p-3 rounded-lg border border-slate-100 transition-colors group">
                     <div>
                         <div class="font-bold text-slate-800 text-sm">${c.name}</div>
                         <div class="text-xs text-slate-500 font-medium mt-0.5">${c.qty} x ${c.price.toFixed(2)}</div>
                     </div>
                     <div class="flex items-center gap-4">
                         <div class="font-bold text-slate-700">Rs ${sub.toFixed(2)}</div>
                         <button onclick="window.cart.splice(${i},1);renderCart()" class="text-slate-300 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-red-50">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                         </button>
                     </div>
                  </div>`;
            }).join('');

            document.getElementById('cart-list').innerHTML = html || `<div class="h-full flex flex-col items-center justify-center text-slate-300"><svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><p class="font-medium text-sm">Cart is empty</p></div>`;

            document.getElementById('pos-total').innerText = (total - disc).toFixed(2);
            document.getElementById('pos-subtotal').innerText = 'Subtotal: Rs ' + total.toFixed(2);
            document.getElementById('cart-count').innerText = window.cart.length + ' Items';
        };
        window.checkoutPrep = () => {
            if (window.cart.length === 0) return alert("Empty Cart");
            confirmAction("Process Bill?", "checkoutExec");
        };
        window.checkoutExec = async () => {
            const id = await generateID('BILL', 'docs');
            const total = document.getElementById('pos-total').innerText;
            const disc = document.getElementById('pos-disc').value;

            // Deduct Stock (FIFO Logic simplified: Just reduce any batch)
            const batch = writeBatch(db);
            for (let c of window.cart) {
                const qStock = query(collection(db, "stocks"), where("itemCode", "==", c.code), where("loc", "==", session.loc), where("qty", ">", 0), limit(5)); // get a few batches
                const snaps = await getDocs(qStock);
                let remaining = c.qty;

                for (let s of snaps.docs) {
                    if (remaining <= 0) break;
                    const avail = s.data().qty;
                    const take = Math.min(avail, remaining);
                    batch.update(s.ref, { qty: avail - take });
                    remaining -= take;
                }

                if (remaining > 0) console.warn("Negative Stock for " + c.code); // In a real app we block this
                await logHistory(c.code, 'SALE', -c.qty, id);
            }

            await addDoc(collection(db, "docs"), {
                docNo: id, type: 'BILL', total, discount: disc, items: window.cart, date: new Date().toISOString(), loc: session.loc
            });

            await batch.commit();
            await batch.commit();
            window.printDoc(`BILL: ${id} `, `Total: Rs ${total} `, `<thead><tr><th>Item</th><th>Qty</th><th>Price</th></tr></thead><tbody>${window.cart.map(x => `<tr><td>${x.name}</td><td>${x.qty}</td><td>${x.price}</td></tr>`).join('')}</tbody>`);
            loadBilling();
            window.closeModal();
        };
        window.viewOldBills = async () => {
            const raw = await getDocs(query(collection(db, "docs"), where("type", "==", "BILL"), where("loc", "==", session.loc)));
            const snap = { docs: raw.docs.sort((a, b) => new Date(b.data().date) - new Date(a.data().date)).slice(0, 20) };
            const h = snap.docs.map(d => `< tr ><td>${d.data().docNo}</td><td>${d.data().total}</td><td><button onclick="reprintBill('${d.id}')" class="text-blue-500 font-bold">Print</button></td></tr > `).join('');
            openModal("Recent Bills", `< table class="w-full text-left" ><thead><tr><th>No</th><th>Total</th><th></th></tr></thead><tbody>${h}</tbody></table > `);
        };
        window.reprintBill = async (id) => {
            const d = (await getDoc(doc(db, "docs", id))).data();
            window.printDoc(`BILL: ${d.docNo} `, `Date: ${formatDate(d.date)} <br>Total: Rs ${d.total}`, `<thead><tr><th>Item</th><th>Qty</th><th>Price</th></tr></thead><tbody>${d.items.map(x => `<tr><td>${x.name}</td><td>${x.qty}</td><td>${x.price}</td></tr>`).join('')}</tbody>`);
        };

        // === 14. BINCARD ===
        async function loadBincard() {
            const items = await getDocs(collection(db, "items"));
            document.getElementById('app').innerHTML = `
            <div class="card p-6">
                <h3 class="font-bold text-xl mb-4">Bin Card (Item History) - ${session.loc}</h3>
                <div class="flex gap-4 mb-4">
                    <select id="bc-item" class="flex-1 p-3 border rounded text-lg font-bold" onchange="renderBinCard()">${items.docs.map(i => `<option value="${i.data().code}">${i.data().name}</option>`).join('')}</select>
                    <button onclick="exportToExcel('bc-table', 'Bincard_${session.loc}')" class="bg-green-600 text-white px-4 rounded font-bold shadow hover:bg-green-700">Export Excel</button>
                </div>
                <div id="bc-res" class="mt-4"></div>
            </div>`;
            renderBinCard();
        }
        window.renderBinCard = async () => {
            const code = document.getElementById('bc-item').value;
            // Query Logic:
            // Standard: where("loc", "==", session.loc) -> This gets logs physically occurring AT this location

            const q = query(collection(db, "history"), where("itemCode", "==", code), where("loc", "==", session.loc));

            const snap = await getDocs(q);
            // Sort by Date Desc
            snap.docs.sort((a, b) => new Date(b.data().date) - new Date(a.data().date));

            const rows = snap.docs.map(d => {
                const x = d.data();
                const color = x.qty > 0 ? 'text-green-600' : 'text-red-500';
                // Enhanced details for transfers: show from/to
                let details = x.docNo;
                if (x.type === 'TR-OUT') details += ` <span class="text-xs text-slate-400">‚ü∂ ${x.toLoc || '?'}</span>`;
                if (x.type === 'TR-IN') details += ` <span class="text-xs text-slate-400">‚üµ ${x.fromLoc || '?'}</span>`;

                return `<tr class="border-b hover:bg-slate-50 transition">
                <td class="p-3 text-sm text-slate-500 font-mono">${new Date(x.date).toLocaleString()}</td>
                <td class="p-3 font-bold text-sm uppercase tracking-wide">${x.type}</td>
                <td class="p-3 font-black ${color}">${x.qty > 0 ? '+' + x.qty : x.qty}</td>
                <td class="p-3 text-sm font-medium text-slate-700">${details}</td>
                <td class="p-3 text-xs bg-slate-100 rounded text-slate-500">${x.user}</td>
            </tr>`;
            }).join('');

            document.getElementById('bc-res').innerHTML = `<table id="bc-table" class="w-full text-left">
                <thead class="bg-slate-50 border-b border-slate-200 text-xs uppercase text-slate-500">
                    <tr><th class="p-3">Date</th><th class="p-3">Type</th><th class="p-3">Qty</th><th class="p-3">Ref / Flow</th><th class="p-3">User</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-50">${rows}</tbody>
            </table>
            ${snap.empty ? '<div class="p-8 text-center text-slate-400 italic">No history found for this item at this location.</div>' : ''}`;
        };

        // === 15. REPORTS ===
        async function loadReports() {
            document.getElementById('app').innerHTML = `
                <div class="card p-8 text-center max-w-lg mx-auto">
                    <h3 class="font-bold text-2xl mb-8">System Reports (Excel)</h3>
                    <div class="grid gap-4">
                        <button onclick="genRep('STOCK')" class="bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 flex justify-center items-center gap-2"><span class="text-2xl">üì¶</span> Stock Report</button>
                        <button onclick="genRep('SALES')" class="bg-green-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-green-700 flex justify-center items-center gap-2"><span class="text-2xl">üí∞</span> Sales Report</button>
                    </div>
                </div>`;
        }
        window.genRep = async (type) => {
            if (type === 'STOCK') {
                const s = await getDocs(query(collection(db, "stocks"), where("loc", "==", session.loc)));
                const data = s.docs.map(x => ({
                    ItemCode: x.data().itemCode,
                    Qty: x.data().qty,
                    Expiry: x.data().exp,
                    Location: x.data().loc,
                    Date: new Date(x.data().date).toLocaleDateString()
                }));
                exportDataToExcel(data, `Stock_Report_${session.loc}`);
            } else {
                const s = await getDocs(query(collection(db, "docs"), where("type", "==", "BILL"), where("loc", "==", session.loc)));
                const data = s.docs.map(x => ({
                    Date: new Date(x.data().date).toLocaleString(),
                    BillNo: x.data().docNo,
                    Total: x.data().total,
                    Discount: x.data().discount
                }));
                exportDataToExcel(data, `Sales_Report_${session.loc}`);
            }
        };

        window.exportDataToExcel = (data, fileName) => {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, fileName + ".xlsx");
        };
        window.exportToExcel = (tableId, fileName) => {
            const table = document.getElementById(tableId);
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, fileName + ".xlsx");
        };

        // ===================================

        // Start
        initNav();
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);

    </script>
</body>

</html>
