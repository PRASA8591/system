<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMS ELITE | Cloud System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; display: flex; height: 100vh; background: #f8fafc; overflow: hidden; }
        
        /* Sidebar */
        aside { width: 260px; background: #0f172a; color: #94a3b8; display: flex; flex-direction: column; transition: 0.3s; z-index: 50; }
        aside.hide { width: 0; overflow: hidden; }
        .nav-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 13px; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; border-left-color: #3b82f6; }
        
        /* Main Content */
        main { flex: 1; display: flex; flex-direction: column; min-width: 0; background: #f1f5f9; }
        header { height: 64px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        #page-content { flex: 1; padding: 24px; overflow-y: auto; }

        /* Components */
        .card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; border: none; outline: none; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #22c55e; color: white; }
        .btn-secondary { background: #64748b; color: white; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 12px 16px; text-align: left; font-weight: 700; color: #64748b; text-transform: uppercase; font-size: 11px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        tr:hover td { background: #f8fafc; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(2px); }
        .modal.active { display: flex; animation: fadeIn 0.2s ease-out; }
        .modal-card { background: white; width: 100%; max-width: 600px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 90vh; display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* Inputs */
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; outline: none; transition: 0.2s; margin-bottom: 8px; }
        input:focus, select:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px #bfdbfe; }
        label { font-size: 11px; font-weight: 800; text-transform: uppercase; color: #64748b; display: block; margin-bottom: 4px; }
    </style>
</head>
<body>

<aside id="sidebar">
    <div class="p-6 flex items-center gap-3 border-b border-slate-800">
        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-black text-white italic">I</div>
        <div class="font-black text-xl text-white italic tracking-tight">IMS <span class="text-blue-500">ELITE</span></div>
    </div>
    <div id="nav-list" class="flex-1 overflow-y-auto py-4 space-y-1"></div>
    <div class="p-4 bg-slate-900 border-t border-slate-800">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-white">üë§</div>
            <div class="overflow-hidden">
                <div class="text-xs font-bold text-blue-400 uppercase tracking-wider truncate" id="disp-loc">Loading...</div>
                <div class="text-sm font-bold text-white truncate" id="disp-user">Loading...</div>
            </div>
        </div>
    </div>
</aside>

<main>
    <header>
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="text-slate-500 hover:text-slate-800 transition">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            </button>
            <h2 id="page-title" class="text-xl font-black text-slate-800 tracking-tight uppercase">Dashboard</h2>
        </div>
        <button onclick="logout()" class="text-red-500 font-bold text-xs bg-red-50 px-3 py-2 rounded hover:bg-red-100 transition border border-red-100">LOGOUT</button>
    </header>
    <div id="page-content"></div>
</main>

<div id="modal" class="modal">
    <div class="modal-card">
        <div class="p-5 border-b flex justify-between items-center bg-slate-50">
            <h3 id="m-title" class="font-black text-slate-800 text-lg">Title</h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-red-500 font-bold text-xl">&times;</button>
        </div>
        <div id="m-body" class="p-6 overflow-y-auto"></div>
        <div id="m-footer" class="p-5 border-t bg-slate-50 flex justify-end gap-3"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, where, getDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDNpEbBt638KQGgkD4EvtqrRvInupP55zM",
        authDomain: "bills-de7ee.firebaseapp.com",
        projectId: "bills-de7ee",
        storageBucket: "bills-de7ee.firebasestorage.app",
        messagingSenderId: "970664008722",
        appId: "1:970664008722:web:d84829f233a6d40f6bcccb",
        measurementId: "G-WHSRHW81E0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const user = JSON.parse(sessionStorage.getItem('user'));
    const loc = sessionStorage.getItem('loc');
    if(!user || !loc) window.location.href = 'index.html';

    document.getElementById('disp-user').innerText = user.fullName;
    document.getElementById('disp-loc').innerText = loc;

    const PAGES = [
        {id: 'dashboard', n: 'Dashboard', i: 'üìä'}, {id: 'stock_check', n: 'Stock Check', i: 'üîç'},
        {id: 'items', n: 'Item Master', i: 'üì¶'}, {id: 'suppliers', n: 'Suppliers', i: 'üöõ'},
        {id: 'locations', n: 'Locations', i: 'üè¢'}, {id: 'users', n: 'User Access', i: 'üë•'},
        {id: 'direct_add', n: 'Direct Stock', i: '‚ûï'}, {id: 'po', n: 'Purchase Orders', i: 'üìù'},
        {id: 'grn', n: 'GRN Receive', i: 'üì•'}, {id: 'transfer_out', n: 'Transfer Out', i: 'üõ´'},
        {id: 'transfer_in', n: 'Transfer In', i: 'üõ¨'}, {id: 'verification', n: 'Audit / Adjust', i: '‚öñÔ∏è'},
        {id: 'bincard', n: 'Bin Card', i: 'üìã'}, {id: 'billing', n: 'Billing / POS', i: 'üì†'},
        {id: 'reports', n: 'Reports', i: 'üìà'}
    ];

    async function initNav() {
        const snap = await getDocs(query(collection(db, "locations"), where("name", "==", loc)));
        const locData = snap.docs[0]?.data();
        if(!locData) { alert("Location Error"); window.logout(); return; }

        const html = PAGES.map(p => {
            const locHasPage = locData.pages.includes(p.id);
            const userHasPerm = user.username === 'admin' || (user.permissions && user.permissions.includes(p.id));
            if(locHasPage && userHasPerm) {
                return `<div onclick="window.loadPage('${p.id}')" class="nav-item" id="nav-${p.id}">
                    <span class="text-lg">${p.i}</span> ${p.n}
                </div>`;
            }
            return '';
        }).join('');
        document.getElementById('nav-list').innerHTML = html;
        window.loadPage('dashboard');
    }

    // --- UTILITIES ---
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('hide');
    window.logout = () => { sessionStorage.clear(); window.location.href = 'index.html'; };
    window.closeModal = () => document.getElementById('modal').classList.remove('active');
    
    function openModal(title, body, footer) {
        document.getElementById('m-title').innerText = title;
        document.getElementById('m-body').innerHTML = body;
        document.getElementById('m-footer').innerHTML = footer || `<button onclick="closeModal()" class="btn bg-slate-200">Close</button>`;
        document.getElementById('modal').classList.add('active');
    }
    window.openModal = openModal;

    window.confirmAction = (msg, actionCallbackName, ...args) => {
        openModal("‚ö†Ô∏è Confirmation Required", 
            `<div class="text-center font-bold text-slate-700 py-4">${msg}</div>`, 
            `<button onclick="closeModal()" class="btn bg-slate-200">Cancel</button>
             <button id="conf-btn" class="btn btn-primary">Yes, Confirm</button>`);
        document.getElementById('conf-btn').onclick = async () => {
            await window[actionCallbackName](...args);
            window.closeModal();
        };
    };

    async function generateID(prefix, col) {
        const snap = await getDocs(collection(db, col));
        return prefix + (snap.size + 1).toString().padStart(6, '0');
    }

    async function logHistory(itemCode, type, qty, docNo='N/A', fromLoc='', toLoc='') {
        await addDoc(collection(db, "history"), { date: new Date().toISOString(), itemCode, user: user.fullName, type, qty, loc, docNo, fromLoc, toLoc });
    }

    window.printDoc = (title, metaHtml, tableHtml) => {
        const w = window.open('','','width=800,height=800');
        w.document.write(`<html><body style="font-family: sans-serif; padding: 40px;">
            <div style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 20px;"><h1>${title}</h1><h3>IMS ELITE SYSTEM</h3></div>
            <div style="margin-bottom: 20px; font-size: 14px;">${metaHtml}</div>
            <table style="width:100%; border-collapse: collapse; font-size: 12px;" border="1">${tableHtml}</table>
            <div style="margin-top: 40px; font-size: 12px; text-align: center; color: #888;">Generated on ${new Date().toLocaleString()} by ${user.fullName}</div>
        </body></html>`);
        w.print(); w.close();
    };

    // --- 1. DASHBOARD ---
    window.loadDashboard = async () => {
        const sSnap = await getDocs(query(collection(db, "stocks"), where("loc", "==", loc)));
        const iSnap = await getDocs(collection(db, "items"));
        const stocks = sSnap.docs.map(d => d.data());
        const items = iSnap.docs.map(d => d.data());
        let val = 0, exp = 0, low = 0; const now = new Date();
        stocks.forEach(s => {
            const item = items.find(i => i.code === s.itemCode);
            if(item) val += (s.qty * item.cost);
            if(s.qty < 10) low++;
            if(s.exp && s.exp !== 'AUDIT' && s.exp !== 'DIRECT' && new Date(s.exp) < now) exp++;
        });
        document.getElementById('page-content').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="window.dashDetail('val')" class="card p-6 border-l-4 border-blue-500 text-blue-600 cursor-pointer hover:shadow-lg"><div class="text-xs font-bold uppercase text-slate-400 mb-1">Stock Value</div><div class="text-3xl font-black">Rs ${val.toLocaleString(undefined, {minimumFractionDigits:2})}</div></div>
                <div onclick="window.dashDetail('exp')" class="card p-6 border-l-4 border-red-500 text-red-600 cursor-pointer hover:shadow-lg"><div class="text-xs font-bold uppercase text-slate-400 mb-1">Expired Items</div><div class="text-3xl font-black">${exp}</div></div>
                <div onclick="window.dashDetail('low')" class="card p-6 border-l-4 border-yellow-500 text-yellow-600 cursor-pointer hover:shadow-lg"><div class="text-xs font-bold uppercase text-slate-400 mb-1">Low Stock Alerts</div><div class="text-3xl font-black">${low}</div></div>
            </div>`;
    };
    window.dashDetail = async (type) => {
        const sSnap = await getDocs(query(collection(db, "stocks"), where("loc", "==", loc)));
        const iSnap = await getDocs(collection(db, "items"));
        const stocks = sSnap.docs.map(d => d.data()); const items = iSnap.docs.map(d => d.data()); const now = new Date();
        let filtered = [];
        if(type === 'val') filtered = stocks;
        if(type === 'exp') filtered = stocks.filter(s => s.exp && s.exp.includes('-') && new Date(s.exp) < now);
        if(type === 'low') filtered = stocks.filter(s => s.qty < 10);
        const rows = filtered.map(s => { const i = items.find(x => x.code === s.itemCode); return `<tr><td>${s.itemCode}</td><td>${i?.name||'-'}</td><td>${s.qty}</td><td>${s.exp||'-'}</td></tr>`; }).join('');
        openModal("Details", `<table><thead><tr><th>Code</th><th>Item</th><th>Qty</th><th>Exp</th></tr></thead><tbody>${rows}</tbody></table>`);
    };

    // --- 2. STOCK CHECK ---
    window.loadStockCheck = async () => { document.getElementById('page-content').innerHTML = `<div class="card p-6"><input id="sc-search" placeholder="üîç Search..." class="mb-4" onkeyup="window.renderStockCheck()"><div id="sc-table" class="overflow-x-auto"></div></div>`; window.renderStockCheck(); };
    window.renderStockCheck = async () => {
        const q = document.getElementById('sc-search').value.toLowerCase();
        const iSnap = await getDocs(collection(db, "items"));
        const sSnap = await getDocs(query(collection(db, "stocks"), where("loc", "==", loc)));
        const grouped = {};
        sSnap.docs.forEach(d => { const s=d.data(); if(!grouped[s.itemCode]) grouped[s.itemCode]={qty:0, batches:[]}; grouped[s.itemCode].qty+=s.qty; grouped[s.itemCode].batches.push(s); });
        window.currentBatches = grouped; 
        const rows = iSnap.docs.map(d => {
            const i=d.data(); const s=grouped[i.code]||{qty:0, batches:[]};
            if(!i.code.toLowerCase().includes(q) && !i.name.toLowerCase().includes(q)) return '';
            return `<tr class="border-b-2 border-slate-100"><td class="font-bold text-blue-600">${i.code}</td><td class="font-bold">${i.name}</td><td class="text-right font-black text-lg ${s.qty===0?'text-slate-300':'text-slate-800'}">${s.qty}</td><td>${s.qty>0?`<button onclick="window.viewBatches('${i.code}')" class="text-xs bg-slate-100 px-2 py-1 rounded font-bold">View</button>`:'-'}</td></tr>`;
        }).join('');
        document.getElementById('sc-table').innerHTML = `<table><thead><tr><th>Code</th><th>Name</th><th class="text-right">Total</th><th>Details</th></tr></thead><tbody>${rows}</tbody></table>`;
    };
    window.viewBatches = (c) => { const rows = window.currentBatches[c].batches.map(b => `<tr><td>${b.exp || 'N/A'}</td><td>${b.qty}</td></tr>`).join(''); openModal(`Batches: ${c}`, `<table><thead><tr><th>Exp</th><th>Qty</th></tr></thead><tbody>${rows}</tbody></table>`); };

    // --- 3. ITEMS & 4. SUPPLIERS (WITH LABELS) ---
    window.tempData = {}; 
    window.loadItems = async () => { const snap = await getDocs(collection(db, "items")); document.getElementById('page-content').innerHTML = `<div class="flex justify-between mb-4"><h3 class="font-bold text-xl">Items</h3><button onclick="window.itemModal()" class="btn btn-primary">+ New</button></div><div class="card"><table><thead><tr><th>Code</th><th>Name</th><th>Sell</th><th>Action</th></tr></thead><tbody>${snap.docs.map(d => `<tr><td>${d.data().code}</td><td>${d.data().name}</td><td>${d.data().sell}</td><td><button onclick="window.itemModal('${d.id}')" class="text-blue-600 mr-2">Edit</button><button onclick="window.confirmAction('Delete?', 'delItem', '${d.id}')" class="text-red-500">Delete</button></td></tr>`).join('')}</tbody></table></div>`; };
    window.itemModal = async (id=null) => { 
        let d = { code: await generateID('ITEM', 'items'), name:'', cost:0, sell:0 }; if(id) d = (await getDoc(doc(db, "items", id))).data(); 
        window.tempData = {id, ...d}; 
        openModal(id?"Edit":"New", `<div class="grid gap-2"><label>Item Code</label><input value="${d.code}" disabled class="bg-slate-100"><label>Item Name</label><input id="i-n" value="${d.name}" placeholder="Enter Name"><label>Cost Price</label><input id="i-c" value="${d.cost}" type="number" placeholder="0.00"><label>Selling Price</label><input id="i-s" value="${d.sell}" type="number" placeholder="0.00"></div>`, `<button onclick="window.prepareItem()" class="btn btn-primary">Save</button>`); 
    };
    window.prepareItem = () => { window.tempData.name=document.getElementById('i-n').value; window.tempData.cost=parseFloat(document.getElementById('i-c').value); window.tempData.sell=parseFloat(document.getElementById('i-s').value); window.confirmAction('Save Item?', 'saveItem'); };
    window.saveItem = async () => { if(window.tempData.id) await updateDoc(doc(db, "items", window.tempData.id), window.tempData); else await addDoc(collection(db, "items"), window.tempData); window.loadItems(); };
    window.delItem = async (id) => { await deleteDoc(doc(db, "items", id)); window.loadItems(); };

    window.loadSuppliers = async () => { const snap = await getDocs(collection(db, "suppliers")); document.getElementById('page-content').innerHTML = `<div class="flex justify-between mb-4"><h3 class="font-bold text-xl">Suppliers</h3><button onclick="window.supModal()" class="btn btn-primary">+ New</button></div><div class="card"><table><thead><tr><th>Name</th><th>Contact</th><th>Action</th></tr></thead><tbody>${snap.docs.map(d => `<tr><td>${d.data().name}</td><td>${d.data().contact}</td><td><button onclick="window.supModal('${d.id}')" class="text-blue-600 mr-2">Edit</button><button onclick="window.confirmAction('Delete?', 'delSup', '${d.id}')" class="text-red-500">Delete</button></td></tr>`).join('')}</tbody></table></div>`; };
    window.supModal = async (id=null) => { 
        let d = {name:'', contact:''}; if(id) d = (await getDoc(doc(db, "suppliers", id))).data(); window.tempData = {id, ...d}; 
        openModal("Supplier", `<div class="grid gap-2"><label>Supplier Name</label><input id="s-n" value="${d.name}" placeholder="Name"><label>Contact</label><input id="s-c" value="${d.contact}" placeholder="Phone/Email"></div>`, `<button onclick="window.prepareSup()" class="btn btn-primary">Save</button>`); 
    };
    window.prepareSup = () => { window.tempData.name=document.getElementById('s-n').value; window.tempData.contact=document.getElementById('s-c').value; window.confirmAction('Save Supplier?', 'saveSup'); };
    window.saveSup = async () => { if(window.tempData.id) await updateDoc(doc(db, "suppliers", window.tempData.id), window.tempData); else await addDoc(collection(db, "suppliers"), window.tempData); window.loadSuppliers(); };
    window.delSup = async (id) => { await deleteDoc(doc(db, "suppliers", id)); window.loadSuppliers(); };

    // --- 5. LOCATIONS & 6. USERS (WITH LABELS) ---
    window.loadLocations = async () => { const snap=await getDocs(collection(db,"locations")); document.getElementById('page-content').innerHTML=`<div class="flex justify-between mb-4"><h3 class="font-bold text-xl">Locations</h3><button onclick="window.locWiz1()" class="btn btn-primary">+ New</button></div><div class="card"><table>${snap.docs.map(d=>`<tr><td>${d.data().name}</td><td><button onclick="window.locWiz1('${d.id}')" class="text-blue-600 mr-2">Edit</button><button onclick="window.confirmAction('Delete?', 'delLoc', '${d.id}')" class="text-red-500">Delete</button></td></tr>`).join('')}</table></div>`; };
    window.locWiz1 = async (id=null) => { const d=id?(await getDoc(doc(db,"locations",id))).data():{name:'',pages:[]}; window.tempData={id,...d}; openModal("Step 1", `<label>Location Name</label><input id="l-n" value="${d.name}" placeholder="Warehouse Name">`, `<button onclick="window.locWiz2()" class="btn btn-primary">Next</button>`); };
    window.locWiz2 = () => { window.tempData.name=document.getElementById('l-n').value; const checks=PAGES.map(p=>`<label><input type="checkbox" value="${p.id}" class="pg-chk" ${window.tempData.pages.includes(p.id)?'checked':''}> ${p.n}</label>`).join('<br>'); openModal("Step 2: Access", `<div style="height:300px;overflow:auto">${checks}</div>`, `<button onclick="window.prepareLoc()" class="btn btn-primary">Save</button>`); };
    window.prepareLoc = () => { window.tempData.pages=Array.from(document.querySelectorAll('.pg-chk:checked')).map(x=>x.value); window.confirmAction('Save?', 'saveLoc'); };
    window.saveLoc = async () => { if(window.tempData.id) await updateDoc(doc(db,"locations",window.tempData.id),window.tempData); else await addDoc(collection(db,"locations"),window.tempData); window.loadLocations(); };
    window.delLoc = async (id) => { await deleteDoc(doc(db, "locations", id)); window.loadLocations(); };

    window.loadUsers = async () => { const snap=await getDocs(collection(db,"users")); document.getElementById('page-content').innerHTML=`<div class="flex justify-between mb-4"><h3 class="font-bold text-xl">Users</h3><button onclick="window.usrWiz1()" class="btn btn-primary">+ New</button></div><div class="card"><table>${snap.docs.map(d=>`<tr><td>${d.data().username}</td><td><button onclick="window.usrWiz1('${d.id}')" class="text-blue-600 mr-2">Edit</button><button onclick="window.confirmAction('Delete?', 'delUsr', '${d.id}')" class="text-red-500">Delete</button></td></tr>`).join('')}</table></div>`; };
    window.usrWiz1 = async (id=null) => { const d=id?(await getDoc(doc(db,"users",id))).data():{username:'',fullName:'',password:'',allowedLocs:[],permissions:[]}; window.tempData={id,...d}; openModal("Step 1", `<label>Username</label><input id="u-u" value="${d.username}" placeholder="Login ID"><label>Full Name</label><input id="u-f" value="${d.fullName}" placeholder="Display Name"><label>Password</label><input id="u-p" value="${d.password}" placeholder="Secret Key">`, `<button onclick="window.usrWiz2()" class="btn btn-primary">Next</button>`); };
    window.usrWiz2 = async () => { window.tempData.username=document.getElementById('u-u').value; window.tempData.fullName=document.getElementById('u-f').value; window.tempData.password=document.getElementById('u-p').value; const l=await getDocs(collection(db,"locations")); const c=l.docs.map(x=>`<label><input type="checkbox" value="${x.data().name}" class="loc-chk" ${window.tempData.allowedLocs.includes(x.data().name)?'checked':''}> ${x.data().name}</label>`).join('<br>'); openModal("Step 2: Locations", c, `<button onclick="window.usrWiz3()" class="btn btn-primary">Next</button>`); };
    window.usrWiz3 = () => { window.tempData.allowedLocs=Array.from(document.querySelectorAll('.loc-chk:checked')).map(x=>x.value); const c=PAGES.map(p=>`<label><input type="checkbox" value="${p.id}" class="perm-chk" ${window.tempData.permissions.includes(p.id)?'checked':''}> ${p.n}</label>`).join('<br>'); openModal("Step 3: Permissions", `<div style="height:300px;overflow:auto">${c}</div>`, `<button onclick="window.prepareUsr()" class="btn btn-primary">Save</button>`); };
    window.prepareUsr = () => { window.tempData.permissions=Array.from(document.querySelectorAll('.perm-chk:checked')).map(x=>x.value); window.confirmAction('Save?', 'saveUsr'); };
    window.saveUsr = async () => { if(window.tempData.id) await updateDoc(doc(db,"users",window.tempData.id),window.tempData); else await addDoc(collection(db,"users"),window.tempData); window.loadUsers(); };
    window.delUsr = async (id) => { await deleteDoc(doc(db, "users", id)); window.loadUsers(); };

    // --- 7. DIRECT STOCK ---
    window.loadDirectAdd = async () => { const snap=await getDocs(collection(db,"items")); document.getElementById('page-content').innerHTML=`<div class="card p-6 max-w-md mx-auto"><h3 class="font-bold mb-4">Direct Stock</h3><label>Item</label><select id="da-i" class="mb-4">${snap.docs.map(i=>`<option value="${i.data().code}">${i.data().name}</option>`)}</select><label>Quantity</label><input id="da-q" type="number" placeholder="Qty" class="mb-4"><label>Expiry</label><input id="da-e" type="date" class="mb-4"><button onclick="window.confirmAction('Add?','saveDA')" class="btn btn-primary w-full">Add</button></div>`; };
    window.saveDA = async () => { const i=document.getElementById('da-i').value, q=parseFloat(document.getElementById('da-q').value), e=document.getElementById('da-e').value; await addDoc(collection(db,"stocks"),{itemCode:i,loc,qty:q,exp:e}); await logHistory(i,'DIRECT',q); alert("Added"); window.loadDirectAdd(); };

    // --- 8. BILLING ---
    window.cart = [];
    window.loadBilling = async () => { const snap=await getDocs(collection(db,"items")); document.getElementById('page-content').innerHTML=`<div class="flex gap-4 h-full"><div class="flex-1 card p-4 flex flex-col"><div class="flex gap-2 mb-4"><select id="pos-item" class="flex-1">${snap.docs.map(i=>`<option value="${i.data().code}" data-price="${i.data().sell}">${i.data().name} (Rs ${i.data().sell})</option>`)}</select><input id="pos-qty" type="number" value="1" class="w-20 font-bold text-center"><button onclick="window.addToCart()" class="btn btn-primary">ADD</button></div><div class="flex-1 overflow-auto bg-slate-50 p-2 rounded"><table id="cart-table"><thead><tr><th>Item</th><th>Qty</th><th>Total</th><th></th></tr></thead><tbody id="cart-body"></tbody></table></div></div><div class="w-80 flex flex-col gap-4"><div class="card p-6 bg-slate-900 text-white"><div class="text-sm opacity-50">TOTAL</div><div class="text-4xl font-black">Rs <span id="pos-total">0.00</span></div><input id="pos-disc" placeholder="Discount" class="mt-4 bg-slate-800 text-white w-full" onkeyup="window.renderCart()"><button onclick="window.initCheckout()" class="btn btn-success w-full mt-4 font-black text-xl">PAY</button></div><button onclick="window.viewBillHistory()" class="btn btn-secondary w-full">View Bill History</button></div></div>`; };
    window.addToCart = () => { const s=document.getElementById('pos-item'); window.cart.push({code:s.value, name:s.options[s.selectedIndex].text.split(' (')[0], price:parseFloat(s.options[s.selectedIndex].dataset.price), qty:parseFloat(document.getElementById('pos-qty').value)}); window.renderCart(); };
    window.renderCart = () => { let t=0; document.getElementById('cart-body').innerHTML=window.cart.map((c,i)=>{const x=c.price*c.qty; t+=x; return `<tr><td>${c.name}</td><td>${c.qty}</td><td>${x}</td><td><button onclick="window.cart.splice(${i},1);window.renderCart()" class="text-red-500">&times;</button></td></tr>`}).join(''); document.getElementById('pos-total').innerText=(t-(parseFloat(document.getElementById('pos-disc').value)||0)).toFixed(2); };
    window.initCheckout = () => { if(!window.cart.length) return alert("Empty"); window.confirmAction(`Confirm Rs ${document.getElementById('pos-total').innerText}?`, 'processBill'); };
    window.processBill = async () => { const id=await generateID('BILL','docs'), t=document.getElementById('pos-total').innerText; for(let c of window.cart) { const s=await getDocs(query(collection(db,"stocks"),where("loc","==",loc),where("itemCode","==",c.code),limit(1))); if(!s.empty) await updateDoc(doc(db,"stocks",s.docs[0].id),{qty:s.docs[0].data().qty-c.qty}); await logHistory(c.code,'SALE',-c.qty,id); } await addDoc(collection(db,"docs"),{docNo:id,type:'BILL',loc,total:t,items:window.cart,date:new Date().toISOString()}); window.cart=[]; window.loadBilling(); window.printDoc(`BILL ${id}`, `<p>Total: Rs ${t}</p>`, `<thead><tr><th>Item</th><th>Qty</th><th>Price</th></tr></thead><tbody>${window.cart.map(x=>`<tr><td>${x.name}</td><td>${x.qty}</td><td>${x.price}</td></tr>`).join('')}</tbody>`); };
    window.viewBillHistory = async () => { const snap = await getDocs(query(collection(db,"docs"),where("type","==", "BILL"),where("loc","==",loc),orderBy("date","desc"),limit(20))); openModal("Bill History", `<table class="w-full"><thead><tr><th>Bill#</th><th>Date</th><th>Total</th><th>Action</th></tr></thead><tbody>${snap.docs.map(d=>`<tr><td>${d.data().docNo}</td><td>${new Date(d.data().date).toLocaleDateString()}</td><td>${d.data().total}</td><td><button onclick="window.printBillOld('${d.id}')" class="btn btn-primary text-xs">Print</button></td></tr>`).join('')}</tbody></table>`); };
    window.printBillOld = async (id) => { const d=(await getDoc(doc(db,"docs",id))).data(); window.printDoc(`BILL ${d.docNo}`, `<p>Date: ${new Date(d.date).toLocaleString()}</p><p>Total: Rs ${d.total}</p>`, `<thead><tr><th>Item</th><th>Qty</th><th>Price</th></tr></thead><tbody>${d.items.map(x=>`<tr><td>${x.name}</td><td>${x.qty}</td><td>${x.price}</td></tr>`).join('')}</tbody>`); };

    // --- 9. PO & 10. GRN ---
    window.loadPO = async () => { const snap = await getDocs(query(collection(db,"docs"),where("type","==","PO"))); document.getElementById('page-content').innerHTML=`<div class="flex justify-between mb-4"><h3 class="font-bold text-xl">POs</h3><div><button onclick="window.viewPOHistory()" class="btn btn-secondary mr-2">History</button><button onclick="window.createPO()" class="btn btn-primary">+ New</button></div></div><div class="card"><table><thead><tr><th>PO#</th><th>Supplier</th><th>Status</th><th>Action</th></tr></thead><tbody>${snap.docs.map(d=>`<tr><td>${d.data().docNo}</td><td>${d.data().supplier}</td><td>${d.data().status}</td><td>${d.data().status==='PENDING'?`<button onclick="window.loadPage('grn');setTimeout(()=>window.convGRN('${d.data().docNo}'),500)" class="text-green-600 font-bold mr-2">GRN</button><button onclick="window.confirmAction('Delete?','delDoc','${d.id}','po')" class="text-red-500 font-bold">Del</button>`:'-'}</td></tr>`).join('')}</tbody></table></div>`; };
    window.createPO = async () => { const s=await getDocs(collection(db,"suppliers")); const i=await getDocs(collection(db,"items")); window.tempArr=[]; openModal("New PO", `<label>Supplier</label><select id="p-s" class="mb-2">${s.docs.map(x=>`<option>${x.data().name}</option>`)}</select><div class="flex gap-2"><select id="p-i" class="flex-1">${i.docs.map(x=>`<option value="${x.data().code}">${x.data().name}</option>`)}</select><input id="p-q" class="w-20"><button onclick="window.addP()" class="btn btn-primary">Add</button></div><div id="p-l" class="mt-2"></div>`, `<button onclick="window.confirmAction('Save?','savePO')" class="btn btn-primary">Save PO</button>`); };
    window.addP = () => { window.tempArr.push({code:document.getElementById('p-i').value,qty:document.getElementById('p-q').value}); document.getElementById('p-l').innerHTML=window.tempArr.map(x=>`<div>${x.code} : ${x.qty}</div>`).join(''); };
    window.savePO = async () => { const id=await generateID('PO','docs'); await addDoc(collection(db,"docs"),{docNo:id,type:'PO',supplier:document.getElementById('p-s').value,items:window.tempArr,status:'PENDING',date:new Date().toISOString()}); window.loadPO(); };
    window.viewPOHistory = async () => { const snap=await getDocs(query(collection(db,"docs"),where("type","==","PO"),orderBy("date","desc"))); openModal("PO History", `<table>${snap.docs.map(d=>`<tr><td>${d.data().docNo}</td><td><button onclick="window.printOldDoc('${d.id}','PO')" class="btn btn-primary text-xs">Print</button></td></tr>`).join('')}</table>`); };
    window.delDoc = async (id, page) => { await deleteDoc(doc(db,"docs",id)); if(page==='po') window.loadPO(); if(page==='tr') window.loadTransferOut(); };

    window.loadGRN = async () => { document.getElementById('page-content').innerHTML=`<div class="card p-6 max-w-md mx-auto"><h3 class="font-bold mb-4">GRN</h3><div class="flex gap-2 mb-4"><input id="g-r" placeholder="Enter PO Number"><button onclick="window.convGRN(document.getElementById('g-r').value)" class="btn btn-primary">Load</button></div><button onclick="window.viewGRNHistory()" class="btn btn-secondary w-full">View GRN History</button><div id="g-a" class="mt-4"></div></div>`; };
    window.convGRN = async (no) => { const s=await getDocs(query(collection(db,"docs"),where("docNo","==",no),where("type","==","PO"))); if(s.empty) return alert("Invalid"); const d=s.docs[0].data(); window.tempId=s.docs[0].id; window.tempItems=d.items; document.getElementById('g-a').innerHTML=`<table>${d.items.map((x,i)=>`<tr><td>${x.code}</td><td><input id="gq-${i}" value="${x.qty}" class="w-20"></td><td><input type="date" id="ge-${i}"></td></tr>`).join('')}</table><button onclick="window.confirmAction('Save GRN?','saveGRN','${no}')" class="btn btn-success w-full mt-4">Complete</button>`; };
    window.saveGRN = async (ref) => { const id=await generateID('GRN','docs'); for(let i=0;i<window.tempItems.length;i++){ const q=parseFloat(document.getElementById(`gq-${i}`).value); await addDoc(collection(db,"stocks"),{itemCode:window.tempItems[i].code,loc,qty:q,exp:document.getElementById(`ge-${i}`).value}); await logHistory(window.tempItems[i].code,'GRN',q,id); } await addDoc(collection(db,"docs"),{docNo:id,type:'GRN',ref,date:new Date().toISOString(),items:window.tempItems}); await updateDoc(doc(db,"docs",window.tempId),{status:'RECEIVED'}); alert("Done"); window.loadDashboard(); };
    window.viewGRNHistory = async () => { const snap=await getDocs(query(collection(db,"docs"),where("type","==","GRN"),orderBy("date","desc"))); openModal("GRN History", `<table>${snap.docs.map(d=>`<tr><td>${d.data().docNo}</td><td><button onclick="window.printOldDoc('${d.id}','GRN')" class="btn btn-primary text-xs">Print</button></td></tr>`).join('')}</table>`); };

    // --- 11. TRANSFER OUT ---
    window.loadTransferOut = async () => { const l=await getDocs(collection(db,"locations")); const i=await getDocs(collection(db,"items")); const id=await generateID('TR','docs'); window.tempArr=[]; document.getElementById('page-content').innerHTML=`<div class="card p-6 max-w-2xl mx-auto"><h3 class="font-bold mb-4">Transfer Out (${id})</h3><label>To Location</label><select id="t-d" class="mb-4">${l.docs.filter(x=>x.data().name!==loc).map(x=>`<option>${x.data().name}</option>`)}</select><div class="bg-slate-50 p-4 rounded mb-4 flex gap-2"><select id="t-i" class="flex-1" onchange="window.loadBatches(this.value)">${i.docs.map(x=>`<option value="${x.data().code}">${x.data().name}</option>`)}</select><select id="t-b" class="flex-1"></select><input id="t-q" class="w-20" placeholder="Qty"><button onclick="window.addTr()" class="btn btn-primary">Add</button></div><div id="t-l"></div><button onclick="window.confirmAction('Send?','saveTr','${id}')" class="btn btn-primary w-full mt-4">Send</button><button onclick="window.viewTrHistoryOut()" class="btn btn-secondary w-full mt-2">History (Pending)</button></div>`; window.loadBatches(i.docs[0].data().code); };
    window.loadBatches = async (c) => { const s=await getDocs(query(collection(db,"stocks"),where("itemCode","==",c),where("loc","==",loc))); document.getElementById('t-b').innerHTML=s.docs.map(x=>`<option value="${x.id}" data-max="${x.data().qty}">Exp: ${x.data().exp} (Avl: ${x.data().qty})</option>`).join(''); };
    window.addTr = () => { const b=document.getElementById('t-b'); const max=parseFloat(b.options[b.selectedIndex].dataset.max), q=parseFloat(document.getElementById('t-q').value); if(q>max) return alert("Qty exceeds availability"); window.tempArr.push({batchId:b.value,code:document.getElementById('t-i').value,qty:q}); document.getElementById('t-l').innerHTML=window.tempArr.map(x=>`<div>${x.code}: ${x.qty}</div>`).join(''); };
    window.saveTr = async (id) => { const to=document.getElementById('t-d').value; for(let x of window.tempArr){ const r=doc(db,"stocks",x.batchId); await updateDoc(r,{qty:(await getDoc(r)).data().qty-x.qty}); await logHistory(x.code,'TR-OUT',-x.qty,id,loc,to); } await addDoc(collection(db,"docs"),{docNo:id,type:'TRANSFER',fromLoc:loc,toLoc:to,items:window.tempArr,status:'TRANSIT',date:new Date().toISOString()}); window.loadDashboard(); };
    window.viewTrHistoryOut = async () => { const snap=await getDocs(query(collection(db,"docs"),where("type","==","TRANSFER"),where("fromLoc","==",loc),where("status","==","TRANSIT"))); openModal("Pending Sent", `<table>${snap.docs.map(d=>`<tr><td>${d.data().docNo}</td><td><button onclick="window.confirmAction('Cancel?','cancelTr','${d.id}')" class="text-red-500">Cancel</button></td></tr>`).join('')}</table>`); };
    window.cancelTr = async (id) => { const d=(await getDoc(doc(db,"docs",id))).data(); for(let i of d.items){ const r=doc(db,"stocks",i.batchId); await updateDoc(r,{qty:(await getDoc(r)).data().qty+i.qty}); } await deleteDoc(doc(db,"docs",id)); alert("Cancelled"); window.loadTransferOut(); };

    // --- 12. TRANSFER IN ---
    window.loadTransferIn = async () => {
        // Simple query without compound index to avoid errors, sorting done client side
        const q1 = query(collection(db,"docs"),where("toLoc","==",loc),where("status","==","TRANSIT"));
        const p = await getDocs(q1);
        
        const q2 = query(collection(db,"docs"),where("toLoc","==",loc),where("status","==","RECEIVED"));
        const cSnap = await getDocs(q2);
        const cDocs = cSnap.docs.sort((a,b) => b.data().date.localeCompare(a.data().date)).slice(0, 20); // Client side sort

        document.getElementById('page-content').innerHTML=`<h3 class="font-bold text-orange-600 mb-2">Pending</h3><div class="card mb-6"><table>${p.docs.map(d=>`<tr><td>${d.data().docNo}</td><td>From: ${d.data().fromLoc}</td><td><button onclick="window.confirmAction('Recv?','recvTr','${d.id}')" class="btn btn-success text-xs">Receive</button></td></tr>`).join('')}</table></div><h3 class="font-bold text-slate-600 mb-2">History</h3><div class="card"><table>${cDocs.map(d=>`<tr><td>${d.data().docNo}</td><td>${d.data().fromLoc}</td><td><button onclick="window.printOldDoc('${d.id}','TR')" class="btn btn-primary text-xs">Print</button></td></tr>`).join('')}</table></div>`;
    };
    window.recvTr = async (id) => { const d=(await getDoc(doc(db,"docs",id))).data(); for(let x of d.items){ await addDoc(collection(db,"stocks"),{itemCode:x.code,loc,qty:x.qty,exp:'TRANSFER'}); await logHistory(x.code,'TR-IN',x.qty,d.docNo,d.fromLoc,loc); } await updateDoc(doc(db,"docs",id),{status:'RECEIVED'}); window.loadTransferIn(); };

    // --- 13. VERIFICATION (SMART ADJUSTMENT) ---
    window.loadVerification = async () => { const i=await getDocs(collection(db,"items")); document.getElementById('page-content').innerHTML=`<div class="card p-6 max-w-md mx-auto"><h3 class="font-bold mb-4">Verification</h3><label class="text-xs font-bold">1. Select Item</label><select id="v-i" class="mb-4 w-full border p-2" onchange="window.loadExpDates(this.value)">${i.docs.map(x=>`<option value="${x.data().code}">${x.data().name}</option>`)}</select><label class="text-xs font-bold">2. Select Batch</label><select id="v-e" class="mb-4 w-full border p-2"></select><input id="v-q" class="mb-4 w-full border p-2" placeholder="Qty (+/-)"><button onclick="window.confirmAction('Adjust?','saveVer')" class="btn btn-primary w-full">Post</button></div>`; window.loadExpDates(i.docs[0].data().code); };
    window.loadExpDates = async (c) => { 
        // Find existing batches (even if 0 stock)
        const s = await getDocs(query(collection(db,"stocks"), where("itemCode","==",c), where("loc","==",loc))); 
        const dates = [...new Set(s.docs.map(x=>x.data().exp))].sort(); 
        document.getElementById('v-e').innerHTML = dates.map(d=>`<option>${d}</option>`).join('') + `<option value="new">-- New Date --</option>`; 
    };
    window.saveVer = async () => { 
        let e = document.getElementById('v-e').value; const c = document.getElementById('v-i').value, q = parseFloat(document.getElementById('v-q').value);
        if(e === 'new') e = prompt("Enter Expiry (YYYY-MM-DD):"); if(!e) return;
        
        // Check if batch exists
        const s = await getDocs(query(collection(db,"stocks"), where("itemCode","==",c), where("loc","==",loc), where("exp","==",e)));
        if(!s.empty) {
            // Update existing batch
            const docRef = s.docs[0].ref;
            const newQty = s.docs[0].data().qty + q;
            await updateDoc(docRef, {qty: newQty});
        } else {
            // Create new batch
            await addDoc(collection(db,"stocks"), {itemCode:c, loc, qty:q, exp:e}); 
        }
        await logHistory(c, 'AUDIT', q, 'ADJ'); alert("Done"); window.loadVerification(); 
    };

    // --- OTHER ---
    window.printOldDoc = async (id, type) => { const d = (await getDoc(doc(db,"docs",id))).data(); let html = `<thead><tr><th>Item</th><th>Qty</th></tr></thead><tbody>`; if(d.items) html += d.items.map(x=>`<tr><td>${x.code}</td><td>${x.qty}</td></tr>`).join(''); html += `</tbody>`; window.printDoc(`${type} : ${d.docNo}`, `<p>Date: ${new Date(d.date).toLocaleString()}</p><p>Status: ${d.status||'Completed'}</p>`, html); };
    window.loadBincard = async () => { const i=await getDocs(collection(db,"items")); document.getElementById('page-content').innerHTML=`<select class="card p-2 mb-4" onchange="window.renderBin(this.value)">${i.docs.map(x=>`<option value="${x.data().code}">${x.data().name}</option>`)}</select><div id="bv" class="card"></div>`; window.renderBin(i.docs[0].data().code); };
    window.renderBin = async (c) => { const h=await getDocs(query(collection(db,"history"),where("itemCode","==",c),where("loc","==",loc),orderBy("date","desc"))); document.getElementById('bv').innerHTML=`<table>${h.docs.map(d=>`<tr><td>${new Date(d.data().date).toLocaleDateString()}</td><td>${d.data().type}</td><td>${d.data().qty}</td></tr>`).join('')}</table>`; };
    window.loadReports = () => { document.getElementById('page-content').innerHTML=`<div class="card p-6 text-center"><button onclick="window.genRep('S')" class="btn btn-primary m-2">Stock</button><button onclick="window.genRep('H')" class="btn btn-secondary m-2">Sales</button></div>`; };
    window.genRep = async (t) => { if(t==='S'){ const s=await getDocs(query(collection(db,"stocks"),where("loc","==",loc))); window.printDoc("Stock Report", `Location: ${loc}`, `<thead><tr><th>Item</th><th>Qty</th><th>Exp</th></tr></thead><tbody>${s.docs.map(x=>`<tr><td>${x.data().itemCode}</td><td>${x.data().qty}</td><td>${x.data().exp}</td></tr>`).join('')}</tbody>`); } else { const h=await getDocs(query(collection(db,"history"),where("type","==","SALE"),where("loc","==",loc))); window.printDoc("Sales Report", `Location: ${loc}`, `<thead><tr><th>Date</th><th>Item</th><th>Qty</th></tr></thead><tbody>${h.docs.map(x=>`<tr><td>${new Date(x.data().date).toLocaleDateString()}</td><td>${x.data().itemCode}</td><td>${x.data().qty}</td></tr>`).join('')}</tbody>`); } };

    window.loadPage = (id) => {
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active')); document.getElementById('nav-'+id)?.classList.add('active');
        document.getElementById('page-title').innerText = PAGES.find(p=>p.id===id).n;
        const routes = {
            dashboard: window.loadDashboard, stock_check: window.loadStockCheck, items: window.loadItems,
            suppliers: window.loadSuppliers, locations: window.loadLocations, users: window.loadUsers,
            direct_add: window.loadDirectAdd, billing: window.loadBilling, po: window.loadPO, 
            grn: window.loadGRN, transfer_out: window.loadTransferOut, transfer_in: window.loadTransferIn, 
            verification: window.loadVerification, bincard: window.loadBincard, reports: window.loadReports
        };
        if(routes[id]) routes[id]();
    };

    initNav();
</script>
</body>
</html>
