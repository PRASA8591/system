<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMS ELITE | Secure Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #0f172a; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; width: 400px; padding: 40px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 1px solid rgba(255,255,255,0.1); }
        .inp { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 16px; outline: none; font-weight: 600; transition: 0.3s; }
        .inp:focus { border-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .btn-login { width: 100%; background: #3b82f6; color: white; padding: 16px; border-radius: 12px; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: 0.3s; border: none; }
        .btn-login:hover:not(:disabled) { background: #2563eb; transform: translateY(-2px); }
        .btn-login:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.7; }
        .status-badge { font-size: 10px; padding: 4px 12px; border-radius: 20px; font-weight: 900; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="login-card">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-black italic tracking-tighter text-slate-800">IMS<span class="text-blue-600">ELITE</span></h1>
            <div id="db-status" class="mt-2">
                <span class="status-badge bg-orange-100 text-orange-600 animate-pulse">Connecting to Cloud...</span>
            </div>
        </div>

        <form id="loginForm">
            <div class="space-y-1 mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Identity</label>
                <input type="text" id="u" placeholder="Username" class="inp" required>
            </div>
            
            <div class="space-y-1 mb-4">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Passkey</label>
                <input type="password" id="p" placeholder="••••••••" class="inp" required>
            </div>

            <div class="space-y-1 mb-6">
                <label class="text-[10px] font-black uppercase text-slate-400 ml-1">Access Point</label>
                <select id="l" class="inp cursor-pointer bg-slate-50">
                    <option value="" disabled selected>Loading Locations...</option>
                </select>
            </div>
            
            <button type="submit" id="loginBtn" class="btn-login" disabled>Syncing...</button>
        </form>

        <div id="err" class="mt-4 text-center text-xs font-bold text-red-500 hidden bg-red-50 p-3 rounded-lg border border-red-100"></div>

        <div class="mt-8 pt-6 border-t border-slate-100 text-center">
            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-2">Master Credentials</p>
            <code class="text-xs bg-slate-100 px-3 py-1 rounded-md text-slate-600 font-bold">admin / admin123</code>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, query, where, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDNpEbBt638KQGgkD4EvtqrRvInupP55zM",
            authDomain: "bills-de7ee.firebaseapp.com",
            projectId: "bills-de7ee",
            storageBucket: "bills-de7ee.firebasestorage.app",
            messagingSenderId: "970664008722",
            appId: "1:970664008722:web:d84829f233a6d40f6bcccb",
            measurementId: "G-WHSRHW81E0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const allPages = ["dashboard","stock_check","items","suppliers","locations","users","direct_add","po","grn","transfer_out","transfer_in","verification","bincard","reports","billing"];

        async function initSystem() {
            try {
                // 1. Ensure a Location exists
                const locSnap = await getDocs(collection(db, "locations"));
                if (locSnap.empty) {
                    await addDoc(collection(db, "locations"), {
                        name: "Main Warehouse", 
                        remark: "Global HQ", 
                        pages: allPages
                    });
                }

                // 2. Ensure Master Admin exists
                const userSnap = await getDocs(query(collection(db, "users"), where("username", "==", "admin"), limit(1)));
                if (userSnap.empty) {
                    await addDoc(collection(db, "users"), {
                        fullName: "Master Admin", 
                        username: "admin", 
                        password: "admin123", 
                        allowedLocs: ["Main Warehouse"], 
                        permissions: allPages
                    });
                }

                // 3. Populate Location Dropdown
                const locs = await getDocs(collection(db, "locations"));
                const sel = document.getElementById('l');
                sel.innerHTML = locs.docs.map(doc => `<option value="${doc.data().name}">${doc.data().name}</option>`).join('');
                
                // 4. Activate UI
                document.getElementById('db-status').innerHTML = '<span class="status-badge bg-green-100 text-green-600">Cloud Online</span>';
                const btn = document.getElementById('loginBtn');
                btn.disabled = false;
                btn.innerText = "Authorized Entry";

            } catch (e) {
                console.error(e);
                showErr("FIREBASE ERROR: Check console for configuration issues.");
            }
        }

        async function login(e) {
            e.preventDefault();
            const u = document.getElementById('u').value.trim();
            const p = document.getElementById('p').value.trim();
            const l = document.getElementById('l').value;
            
            document.getElementById('err').classList.add('hidden');

            try {
                const q = query(collection(db, "users"), where("username", "==", u), limit(1));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const matchedUser = querySnapshot.docs[0].data();
                    if (matchedUser.password === p) {
                        if (matchedUser.username === 'admin' || matchedUser.allowedLocs.includes(l)) {
                            sessionStorage.setItem('user', JSON.stringify(matchedUser));
                            sessionStorage.setItem('loc', l);
                            window.location.href = 'main.html';
                        } else {
                            showErr("ACCESS DENIED: No permission for this location.");
                        }
                    } else {
                        showErr("INVALID: Password incorrect.");
                    }
                } else {
                    showErr("INVALID: Username not found.");
                }
            } catch (e) {
                showErr("CLOUD ERROR: Failed to query database.");
            }
        }

        function showErr(msg) {
            const err = document.getElementById('err');
            err.innerText = msg;
            err.classList.remove('hidden');
        }

        document.getElementById('loginForm').onsubmit = login;
        window.onload = initSystem;
    </script>
</body>
</html>
